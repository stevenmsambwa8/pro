<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Update Password</title>  
</head>  
<body>  
    <h1>Update Password</h1>  
    <p id="status">Loading...</p>  
    <input type="password" id="password" placeholder="New Password">  
    <input type="password" id="password2" placeholder="Repeat New Password">  
    <button id="submitBtn">Update Password</button>  
  
   <script type="module">
import { supabase } from './supabase-client.js'

const status = document.getElementById("status");
const submitBtn = document.getElementById("submitBtn");

// Read token from hash
const hashParams = new URLSearchParams(window.location.hash.replace('#', '?'));
const access_token = hashParams.get('access_token');
const type = hashParams.get('type');

if (!access_token || type !== 'recovery') {
    status.textContent = "Invalid or expired reset link.";
    status.style.color = "red";
    submitBtn.disabled = true;
} else {
    console.log("Token and type found:", { access_token, type });
}

submitBtn.addEventListener("click", async () => {
    const pass1 = document.getElementById("password").value;
    const pass2 = document.getElementById("password2").value;

    if (!pass1 || !pass2) {
        status.textContent = "Please fill out both fields.";
        status.style.color = "red";
        return;
    }

    if (pass1 !== pass2) {
        status.textContent = "Passwords do not match.";
        status.style.color = "red";
        return;
    }

    status.textContent = "Updating password...";
    status.style.color = "orange";

    try {
        const { data, error } = await supabase.auth.updateUser({
            access_token,
            password: pass1
        });

        if (error) {
            status.textContent = error.message;
            status.style.color = "red";
            console.error(error);
        } else {
            status.textContent = "Password updated! Redirecting...";
            status.style.color = "green";
            setTimeout(() => window.location.href = "/index.html", 1200);
        }
    } catch (err) {
        console.error(err);
        status.textContent = "Unexpected error.";
        status.style.color = "red";
    }
});
</script>
  
</body>  
</html>  
