<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="logo.png" type="image/x-icon">
<meta name="theme-color" content="#000000">
<title>VYNAL Live Debate - Pro Dashboard</title>
<link rel="stylesheet" href="remixicon.min.css">
<link rel="stylesheet" href="pro.css">
<link rel="stylesheet" href="inter.css">
<script src="https://www.paypal.com/sdk/js?client-id=AUOquOrBAj4hRVIlyydpdK_tKcmG4AN_o8IK3Tu1b9d8R24o3f9Wm1NsONdMBvTY3hCxniqU0WRiZAom&currency=USD"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
/* Access Blocker Overlay */
.access-blocker {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #000000;
  z-index: 9999;
  display: none;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.4s ease;
}

.access-blocker.active {
  display: flex;
  opacity: 1;
}

.access-blocker-content {
  text-align: center;
  max-width: 500px;
  padding: 40px;
  animation: slideUp 0.5s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.access-blocker-icon {
  width: 100px;
  height: 100px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 30px;
  font-size: 48px;
  color: #000000;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.access-blocker-title {
  font-size: 32px;
  font-weight: 800;
  color: white;
  margin: 0 0 16px 0;
}

.access-blocker-subtitle {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.7);
  margin: 0 0 32px 0;
  line-height: 1.6;
}

.access-blocker-btn {
  background: white;
  color: #000000;
  border: none;
  border-radius: 12px;
  padding: 18px 48px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
}

.access-blocker-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(255, 255, 255, 0.4);
}

/* Bottom Sheet Premium Modal */
.premium-bottom-sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #ffffff;
  border-radius: 24px 24px 0 0;
  z-index: 10001;
  max-height: 90vh;
  overflow-y: auto;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.3);
}

.premium-bottom-sheet.active {
  transform: translateY(0);
}

.premium-sheet-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(5px);
  z-index: 10000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.premium-sheet-overlay.active {
  opacity: 1;
  pointer-events: all;
}

.sheet-handle {
  width: 40px;
  height: 4px;
  background: #e0e0e0;
  border-radius: 2px;
  margin: 12px auto 0;
}

.sheet-content {
  padding: 24px 24px 40px;
}

.sheet-header {
  text-align: center;
  margin-bottom: 32px;
}

.premium-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: #000000;
  padding: 8px 20px;
  border-radius: 50px;
  font-size: 14px;
  font-weight: 600;
  color: white;
  margin-bottom: 16px;
}

.premium-title {
  font-size: 36px;
  font-weight: 800;
  color: #000000;
  margin: 0 0 12px 0;
  line-height: 1.1;
}

.premium-subtitle {
  font-size: 16px;
  color: #666666;
  margin: 0;
  line-height: 1.6;
}

.premium-features {
  display: grid;
  gap: 12px;
  margin: 32px 0;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 16px;
  background: #f5f5f5;
  padding: 16px;
  border-radius: 12px;
  transition: all 0.3s ease;
}

.feature-item:hover {
  background: #eeeeee;
  transform: translateX(4px);
}

.feature-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: #000000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  flex-shrink: 0;
}

.feature-text {
  flex: 1;
}

.feature-title {
  font-size: 16px;
  font-weight: 700;
  color: #000000;
  margin: 0 0 4px 0;
}

.feature-desc {
  font-size: 13px;
  color: #666666;
  margin: 0;
}

.premium-pricing {
  background: #000000;
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  margin: 24px 0;
}

.premium-price {
  font-size: 48px;
  font-weight: 900;
  color: white;
  line-height: 1;
  margin: 0;
}

.premium-price-suffix {
  font-size: 18px;
  color: rgba(255, 255, 255, 0.9);
  margin-left: 8px;
}

.premium-price-note {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.8);
  margin: 8px 0 0 0;
}

.premium-cta-btn {
  width: 100%;
  background: #000000;
  color: white;
  border: none;
  border-radius: 12px;
  padding: 18px 32px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.premium-cta-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
  background: #1a1a1a;
}

.premium-cta-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.premium-cta-btn i {
  font-size: 22px;
}

.premium-note {
  text-align: center;
  font-size: 13px;
  color: #999999;
  margin-top: 16px;
}

.pro-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #000000;
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 8px;
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.limits-header.pro-user {
  background: #000000;
  color: white;
}

.user-limits-card.pro-user {
  border: 2px solid #000000;
}

.limit-item.unlimited .limit-value {
  color: #000000;
  font-weight: 700;
}

.limit-item.unlimited .limit-progress-bar {
  background: #000000;
  width: 100% !important;
}

/* Enhanced Scrollbar */
.premium-bottom-sheet::-webkit-scrollbar {
  width: 8px;
}

.premium-bottom-sheet::-webkit-scrollbar-track {
  background: #f5f5f5;
  border-radius: 4px;
}

.premium-bottom-sheet::-webkit-scrollbar-thumb {
  background: #cccccc;
  border-radius: 4px;
}

.premium-bottom-sheet::-webkit-scrollbar-thumb:hover {
  background: #999999;
}

/* Blur Dashboard Content */
.main.blurred {
  filter: blur(8px);
  pointer-events: none;
  user-select: none;
}

.aside.blurred,
.header.blurred {
  filter: blur(8px);
  pointer-events: none;
}
</style>
</head>
<body>

<!-- Access Blocker for Non-Pro Users -->
<div class="access-blocker" id="accessBlocker">
  <div class="access-blocker-content">
    <div class="access-blocker-icon">
      <i class="ri-lock-fill"></i>
    </div>
    <h1 class="access-blocker-title">Pro Dashboard Access</h1>
    <p class="access-blocker-subtitle">This advanced analytics dashboard is exclusively available for VYNAL Pro members. Upgrade now to unlock unlimited features and insights.</p>
    <button class="access-blocker-btn" id="accessBlockerUpgradeBtn">
      <i class="ri-vip-crown-fill"></i>
      Upgrade to Pro
    </button>
  </div>
</div>

<!-- Premium Bottom Sheet -->
<div class="premium-sheet-overlay" id="premiumSheetOverlay"></div>
<div class="premium-bottom-sheet" id="premiumBottomSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-content">
    <div class="sheet-header">
      <div class="premium-badge">
        <i class="ri-vip-crown-fill"></i>
        VYNAL Pro
      </div>
      <h1 class="premium-title">Upgrade to Pro</h1>
      <p class="premium-subtitle">Unlock unlimited releases, advanced analytics, and exclusive features to grow your music career.</p>
    </div>

    <div class="premium-features">
      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-infinite-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Unlimited Releases</h3>
          <p class="feature-desc">Share as many tracks as you want across all platforms</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-headphone-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Unlimited Audio Previews</h3>
          <p class="feature-desc">Add audio previews to every release without limits</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-edit-2-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Unlimited Edits</h3>
          <p class="feature-desc">Update and refine your releases anytime</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-bar-chart-box-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Advanced Analytics</h3>
          <p class="feature-desc">Deep insights into listener behavior and engagement</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-customer-service-2-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Priority Support</h3>
          <p class="feature-desc">Get help faster with dedicated support</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-flashlight-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Early Access</h3>
          <p class="feature-desc">Be first to try new features and tools</p>
        </div>
      </div>
    </div>

    <div class="premium-pricing">
      <div class="premium-price">$9.99<span class="premium-price-suffix">/month</span></div>
      <p class="premium-price-note">Cancel anytime. No hidden fees.</p>
    </div>

    <button class="premium-cta-btn" id="upgradeToPro">
      <i class="ri-vip-crown-fill"></i>
      Start Pro Membership
    </button>

    <p class="premium-note">âœ¨ Join thousands of artists growing their careers with VYNAL Pro</p>
  </div>
</div>

<aside class="aside" aria-label="Sidebar">
<div class="brand"><span><img src="pro.svg" width="300"></span></div>
<div class="side-group">
<div class="side-label">Main</div>
<nav class="nav" aria-label="Primary">
<a href="/dashboard"><i class="ri-stack-fill"></i><span>Feed</span></a>
<a href="/debates"><i class="ri-compass-2-line"></i><span>Debates</span></a>
<a href="/mall" data-link><i class="ri-shopping-bag-line"></i><span>Mi-mall</span></a>
<a href="/events" data-link><i class="ri-ticket-2-line"></i><span>Mi-events</span></a>
<a href="#" class="active" data-link><i class="ri-filter-3-line"></i><span>Pro.</span></a>
</nav>
</div>
<div class="side-group">
<div class="side-label">Account</div>
<nav class="nav" aria-label="Secondary">
<a href="/account"><i class="ri-user-3-line"></i><span>Profile</span></a>
<a href="/account-settings"><i class="ri-settings-3-line"></i><span>Settings</span></a>
<a class="logout-btn"><i class="ri-logout-box-r-line"></i><span>Logout</span></a>
</nav>
</div>
</aside>

<header class="header" role="banner">
<div class="moblogo">
<span><img src="pro.svg" width="80"></span>
</div>
<div class="searchbar">
</div>
<div class="actions">
<div class="limit">
<button class="btn ghost upgrade-to-pro-btn" style="border:0; margin:0 -15px;background:none;color:grey;"><i class="ri-vip-crown-line t-l"></i></button>
<span class="limited-lock m-t7 m-r-5" style="color: grey;background: black;"><i class="ri-lock-line"></i></span>
</div>
<button class="btn-icon limitModalBtn" aria-label="create" style="margin-right: 5px;border: none;color:white;background:var(--brand);font-size: 20px;padding: 0 20px;"><i class="ri-pie-chart-line"></i></button>
<a><img class="avatar uploading" src="user.webp"></a>
</div>
</header>

<main class="main">
<section class="grid-12">
<div class="artist span-4" id="artistCard">
<span class="artist__label"></span>
<h1 class="artist__name"></h1>
<div class="artist__icons"></div>
</div>

<div class="card span-5" data-animate>
<h2>Add New Release Link</h2>
<form id="uploadForm" class="upload" novalidate>
<div class="row">
<div class="col-6">
<div class="custom-select" data-options="Youtube,Instagram,Spotify,Apple Music">
  <div class="select-selected">Select Platform</div>
</div>
</div>
<div class="col-6"><input class="input" style="background: none;color: white;" type="text" id="uDesc" placeholder="Platform @username"></div>
</div>
<div class="row">
<div class="col-8"><input class="input" style="background: none;color: white;" type="text" id="uTags" placeholder="Release Name"></div>
<div class="col-4"><input class="input" style="background: none;color: white;" type="text" id="uBpm" placeholder="Url"></div>
</div>
<div class="dropzone" id="dropAudio" aria-label="Audio dropzone">
<i class="ri-upload-cloud-2-line"></i> Drop audio file preview here or <u>browse</u>
<input id="uFile" type="file" accept="audio/*" class="sr-only" />
</div>
<span style="text-align: center;">* allowed .mp3 only 1:00 minute</span>
<div style="display:flex; gap:8px; justify-content:flex-end;">
<button type="button" class="btn ghost" id="uReset"><i class="ri-restart-line"></i> Reset</button>
<button class="btn primary" id="uSubmit" type="submit"><i class="ri-upload-2-line"></i> Upload</button>
</div>
</form>
</div>
<div class="chart-container span-3">
<canvas id="platformChart"></canvas>
</div>
</section>

<section class="grid-12">
  <div class="chart-container span-3">
    <canvas id="timelineChart"></canvas>
  </div>
  <div class="chart-container span-3">
    <canvas id="actionChart"></canvas>
  </div>
  <div class="chart-container span-3">
    <canvas id="platformActionChart"></canvas>
  </div>
  <div class="chart-container span-3">
    <canvas id="topReleasesChart"></canvas>
  </div>
</section>

<section class="grid-12">
<div class="span-12" id="engagementStats"></div>
</section>

<div class="modal-backdrop hidden" id="limitModal">
<div class="modal" role="document" style="max-width: 700px;background: transparent;">
<div style="display:flex; align-items:center; justify-content:space-between;">
<strong style="color: black;"></strong>
<button class="btn-icon" id="limitClose" style="color: rgb(255, 255, 255);"><i class="ri-close-line ri-xl"></i></button>
</div>
<div class="divider"></div>
<div class="user-limits-card">
  <div class="limits-header">
    <i class="ri-pie-chart-line"></i>
    <h3>Your Plan Limits</h3>
  </div>
  
  <div class="limits-grid">
    <div class="limit-item">
      <div class="limit-icon-wrapper">
        <i class="ri-music-2-fill limit-icon"></i>
      </div>
      <div class="limit-info">
        <div class="limit-label">Releases</div>
        <div class="release-limit-display limit-value">0/6</div>
      </div>
      <div class="limit-progress">
        <div class="limit-progress-bar release-progress"></div>
      </div>
    </div>
    
    <div class="limit-item">
      <div class="limit-icon-wrapper">
        <i class="ri-headphone-fill limit-icon"></i>
      </div>
      <div class="limit-info">
        <div class="limit-label">Audio Previews</div>
        <div class="audio-limit-display limit-value">0/10</div>
      </div>
      <div class="limit-progress">
        <div class="limit-progress-bar audio-progress"></div>
      </div>
    </div>
    
    <div class="limit-item">
      <div class="limit-icon-wrapper">
        <i class="ri-edit-2-fill limit-icon"></i>
      </div>
      <div class="limit-info">
        <div class="limit-label">Edits</div>
        <div class="edits-limit-display limit-value">1 remaining</div>
      </div>
      <div class="limit-progress">
        <div class="limit-progress-bar edits-progress"></div>
      </div>
    </div>
  </div>
  
  <div class="limits-footer" id="limitsFooter">
    <i class="ri-information-line"></i>
    <span>Upgrade to Pro for unlimited releases, audio previews, and edits</span>
  </div>
</div>
</div>
</div>

<section class="grid-12" id="releasesContainer"></section>
</main>

<div class="space"></div>

<div class="modal-backdrop hidden" id="linkModal">
<div class="modal" role="document">
<div style="display:flex; align-items:center; justify-content:space-between;">
<strong style="color: black;">Share Post</strong>
<button class="btn-icon" id="linkClose" style="color: black;"><i class="ri-close-line"></i></button>
</div>
<div class="divider"></div>
<div style="display:grid; gap:10px; margin-top:10px;">
<button class="btn ghost"><i class="ri-link"></i> Copy Link</button>
<button class="btn ghost"><i class="ri-twitter-line"></i> Share to Twitter</button>
<button class="btn ghost"><i class="ri-facebook-circle-line"></i> Share to Facebook</button>
<button class="btn ghost"><i class="ri-telegram-line"></i> Share to Telegram</button>
</div>
</div>
</div>


<script type="module">
  import { supabase } from './supabase-client.js'

let isPro = false
let analyticsCharts = {}

// Utility Functions
const notify = (message, color = '#10b981') => {
  const modal = document.createElement('div')
  modal.className = 'notification-modal-overlay'
  const iconMap = {'#10b981': 'ri-checkbox-circle-fill', '#ef4444': 'ri-error-warning-fill', '#3b82f6': 'ri-information-fill', '#f59e0b': 'ri-alert-fill'}
  modal.innerHTML = `
    <div class="notification-modal-content">
      <i class="${iconMap[color] || 'ri-checkbox-circle-fill'} notification-modal-icon" style="color: ${color}"></i>
      <p class="notification-modal-message">${message}</p>
      <button class="notification-modal-btn">OK</button>
    </div>
  `
  document.body.appendChild(modal)
  setTimeout(() => modal.classList.add('active'), 10)
  const closeModal = () => {
    modal.classList.remove('active')
    setTimeout(() => modal.remove(), 300)
  }
  modal.querySelector('.notification-modal-btn').addEventListener('click', closeModal)
  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal() })
  setTimeout(closeModal, 3000)
}

const confirm = (message) => new Promise((resolve) => {
  const modal = document.createElement('div')
  modal.className = 'confirm-modal-overlay'
  modal.innerHTML = `
    <div class="confirm-modal-content">
      <i class="ri-alert-fill confirm-modal-icon"></i>
      <h3 class="confirm-modal-title">Confirm Action</h3>
      <p class="confirm-modal-message">${message}</p>
      <div class="confirm-modal-actions">
        <button class="confirm-modal-btn confirm-cancel">Cancel</button>
        <button class="confirm-modal-btn confirm-delete">Confirm</button>
      </div>
    </div>
  `
  document.body.appendChild(modal)
  setTimeout(() => modal.classList.add('active'), 10)
  const closeModal = (result) => {
    modal.classList.remove('active')
    setTimeout(() => { modal.remove(); resolve(result) }, 300)
  }
  modal.querySelector('.confirm-cancel').addEventListener('click', () => closeModal(false))
  modal.querySelector('.confirm-delete').addEventListener('click', () => closeModal(true))
  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(false) })
})

const formatTime = (s) => `${Math.floor(s/60)}`.padStart(2,'0')+':'+`${s%60}`.padStart(2,'0')

// Pro Payment System
const showPremiumBottomSheet = () => {
  const overlay = document.getElementById('premiumSheetOverlay')
  const sheet = document.getElementById('premiumBottomSheet')
  overlay.classList.add('active')
  setTimeout(() => sheet.classList.add('active'), 10)
}

const hidePremiumBottomSheet = () => {
  const overlay = document.getElementById('premiumSheetOverlay')
  const sheet = document.getElementById('premiumBottomSheet')
  sheet.classList.remove('active')
  setTimeout(() => overlay.classList.remove('active'), 400)
}

document.getElementById('premiumSheetOverlay')?.addEventListener('click', hidePremiumBottomSheet)
document.addEventListener('click', (e) => {
  if (e.target.closest('.upgrade-to-pro-btn') || e.target.closest('.upgrade-prompt-btn')) {
    showPremiumBottomSheet()
  }
})
document.getElementById('accessBlockerUpgradeBtn')?.addEventListener('click', showPremiumBottomSheet)

// PayPal Payment Handler - ONE-TIME PAYMENT FOR 30 DAYS
document.getElementById('upgradeToPro')?.addEventListener('click', async () => {
  if (!window.currentSession) return
  
  const upgradeBtn = document.getElementById('upgradeToPro')
  upgradeBtn.style.display = 'none'
  
  let paypalContainer = document.getElementById('paypal-button-container')
  if (!paypalContainer) {
    paypalContainer = document.createElement('div')
    paypalContainer.id = 'paypal-button-container'
    upgradeBtn.parentNode.insertBefore(paypalContainer, upgradeBtn.nextSibling)
  }
  
  paypal.Buttons({
    style: { shape: 'rect', color: 'gold', layout: 'vertical', label: 'pay' },
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: { value: '4.99', currency_code: 'USD' },
          description: 'VYNAL Pro - 30 Days Access',
          custom_id: window.currentSession.user.id
        }],
        application_context: { shipping_preference: 'NO_SHIPPING' }
      })
    },
    onApprove: async function(data, actions) {
      notify('Processing payment...', '#3b82f6')
      return actions.order.capture().then(async function(details) {
        try {
          const expiresAt = new Date()
          expiresAt.setDate(expiresAt.getDate() + 30)
          
          const { error: profileError } = await supabase
            .from('profiles')
            .update({ 
              tier: 'pro',
              payment_id: details.id,
              upgraded_at: new Date().toISOString(),
              pro_expires_at: expiresAt.toISOString()
            })
            .eq('id', window.currentSession.user.id)
          
          if (profileError) throw profileError
          
          await supabase.from('transactions').insert({
            user_id: window.currentSession.user.id,
            payment_id: details.id,
            amount: 4.99,
            currency: 'USD',
            status: details.status,
            payment_method: 'paypal',
            created_at: new Date().toISOString()
          })
          
          notify('ðŸŽ‰ Payment successful! You have Pro access for 30 days!', '#10b981')
          setTimeout(() => window.location.reload(), 2000)
          
        } catch (error) {
          notify('Payment received but upgrade failed. Contact support with ID: ' + details.id, '#ef4444')
          console.error('Upgrade error:', error)
        }
      })
    },
    onError: function(err) {
      notify('Payment failed. Please try again.', '#ef4444')
      console.error('PayPal error:', err)
      upgradeBtn.style.display = 'block'
      paypalContainer.innerHTML = ''
    },
    onCancel: function() {
      notify('Payment cancelled', '#f59e0b')
      upgradeBtn.style.display = 'block'
      paypalContainer.innerHTML = ''
    }
  }).render('#paypal-button-container')
})

// Pro Expiration Checker
const checkProExpiration = async (userId) => {
  const { data: profile } = await supabase
    .from('profiles')
    .select('tier, pro_expires_at')
    .eq('id', userId)
    .single()
  
  if (profile.tier === 'pro' && profile.pro_expires_at) {
    const expiresAt = new Date(profile.pro_expires_at)
    const now = new Date()
    
    if (now > expiresAt) {
      await supabase.from('profiles').update({ tier: 'free', pro_expires_at: null }).eq('id', userId)
      notify('Your Pro access has expired. Renew to continue!', '#f59e0b')
      setTimeout(() => window.location.reload(), 2000)
    } else {
      const daysRemaining = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24))
      if (daysRemaining <= 7) showRenewalReminder(daysRemaining)
    }
  }
}

const showRenewalReminder = (daysRemaining) => {
  const reminderDiv = document.createElement('div')
  reminderDiv.className = 'renewal-reminder'
  reminderDiv.innerHTML = `
    <div style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); color: white; padding: 16px; border-radius: 12px; margin: 16px; text-align: center;">
      <i class="ri-alarm-warning-fill" style="font-size: 24px;"></i>
      <p style="margin: 8px 0; font-weight: 600;">Your Pro access expires in ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''}!</p>
      <button onclick="showPremiumBottomSheet()" class="btn primary" style="background: white; color: #ef4444; margin-top: 8px;">
        Renew Now for $4.99
      </button>
    </div>
  `
  const container = document.querySelector('.main') || document.body
  container.insertBefore(reminderDiv, container.firstChild)
}

// Auth & Pro Status
const initAuth = async () => {
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) return window.location.href = 'register'

  const { data: profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single()
  
  window.currentUser = profile
  window.currentSession = session
  
  let isProActive = false
  if (profile.tier === 'pro') {
    if (profile.pro_expires_at) {
      const expiresAt = new Date(profile.pro_expires_at)
      isProActive = new Date() <= expiresAt
      if (!isProActive) {
        await supabase.from('profiles').update({ tier: 'free', pro_expires_at: null }).eq('id', session.user.id)
        profile.tier = 'free'
      }
    } else {
      isProActive = true
    }
  }
  
  isPro = isProActive
  
  if (!isPro) {
    document.getElementById('accessBlocker')?.classList.add('active')
    document.querySelectorAll('.main, .aside, .header').forEach(el => el.classList.add('blurred'))
  } else {
    document.getElementById('accessBlocker')?.remove()
  }
  
  document.querySelectorAll('.artist__name, .user-name').forEach(el => {
    el.innerHTML = (profile.stage_name || 'Artist') + (isPro ? '<span class="pro-badge"><i class="ri-vip-crown-fill"></i>PREMIUM</span>' : '')
  })
  document.querySelectorAll('.profile-picture, .uploading').forEach(el => el.src = profile.profile_picture || 'user.webp')
  document.querySelectorAll('.artist__label').forEach(el => el.textContent = profile.role || 'Artist')
  
  const card = document.getElementById('artistCard')
  if (card && profile.profile_picture) {
    card.style.backgroundImage = `url('${profile.profile_picture}')`
    card.style.backgroundSize = 'cover'
    card.style.backgroundPosition = 'center'
  }
  
  if (isPro) {
    document.querySelector('.upgrade-to-pro-btn')?.remove()
    document.querySelector('.limited-lock')?.remove()
    document.querySelectorAll('.user-limits-card, .limits-header').forEach(el => el.classList.add('pro-user'))
    const footer = document.getElementById('limitsFooter')
    if (footer) footer.innerHTML = '<i class="ri-vip-crown-fill" style="color:#000000"></i><span style="color:#000000;font-weight:700">PRO Plan Active - Unlimited Everything!</span>'
    document.querySelectorAll('.main, .aside, .header').forEach(el => el.classList.remove('blurred'))
  }
  
  return { session, profile }
}

const checkUserLimits = async (userId) => {
  const { data: profile } = await supabase
    .from('profiles')
    .select('current_release_count, max_releases, current_audio_count, max_audio_previews, edits_remaining, tier, max_edits')
    .eq('id', userId)
    .single()
  
  return profile.tier === 'pro' ? {
    ...profile,
    max_releases: 999999,
    max_audio_previews: 999999,
    edits_remaining: 999999,
    max_edits: 999999
  } : profile
}

const canUpload = async (userId, type) => {
  if (isPro) return { allowed: true, message: 'Unlimited for PRO users' }
  
  const limits = await checkUserLimits(userId)
  const checks = {
    release: () => limits.current_release_count >= limits.max_releases ? 
      { allowed: false, message: `Release limit reached (${limits.max_releases} max). Upgrade to Pro!`, showUpgrade: true } : null,
    audio: () => limits.current_audio_count >= limits.max_audio_previews ? 
      { allowed: false, message: `Audio preview limit reached (${limits.max_audio_previews} max). Upgrade to Pro!`, showUpgrade: true } : null,
    edit: () => limits.edits_remaining <= 0 ? 
      { allowed: false, message: 'Edit limit reached. Upgrade to Pro!', showUpgrade: true } : null
  }
  
  return checks[type]?.() || { allowed: true }
}

const uploadAudio = async (file, session) => {
  if (!file.type.startsWith('audio/')) throw new Error('Only audio files allowed')
  if (file.size > 3*1024*1024) throw new Error('Max 3MB')
  
  const check = await canUpload(session.user.id, 'audio')
  if (!check.allowed) {
    if (check.showUpgrade) showPremiumBottomSheet()
    throw new Error(check.message)
  }

  const audio = new Audio()
  const duration = await new Promise((res, rej) => {
    audio.src = URL.createObjectURL(file)
    audio.onloadedmetadata = () => {
      const dur = Math.floor(audio.duration)
      URL.revokeObjectURL(audio.src)
      dur > 60 ? rej(new Error('Max 60 seconds')) : res(dur)
    }
    audio.onerror = () => rej(new Error('Invalid audio'))
  })

  const fileName = `${session.user.id}/${Date.now()}.${file.name.split('.').pop()}`
  const { error } = await supabase.storage.from('audio-previews').upload(fileName, file, { cacheControl: '3600' })
  if (error) throw error

  const { data } = supabase.storage.from('audio-previews').getPublicUrl(fileName)
  return { url: data.publicUrl, duration }
}

// Social Links
const getSocialLinks = async (userId) => {
  const { data } = await supabase.from('user_social_links').select('*').eq('user_id', userId)
  return data?.reduce((acc, l) => ({ ...acc, [l.platform]: { username: l.username, url: l.profile_url, verified: l.is_verified } }), {}) || {}
}

const saveSocialLink = async (platform, username, url, userId) => {
  const { data: existing } = await supabase.from('user_social_links').select('id').eq('user_id', userId).eq('platform', platform).maybeSingle()
  
  const payload = { username, profile_url: url, updated_at: new Date().toISOString() }
  
  if (existing) {
    await supabase.from('user_social_links').update(payload).eq('id', existing.id)
  } else {
    await supabase.from('user_social_links').insert({ user_id: userId, platform, ...payload })
  }
}

// Analytics
const getVisitorId = () => {
  let id = localStorage.getItem('vynal_visitor_id')
  if (!id) {
    id = `visitor_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    localStorage.setItem('vynal_visitor_id', id)
  }
  return id
}

const trackListener = async (previewId, action, artistId) => {
  if (!artistId || !previewId || window.currentSession?.user?.id === artistId) return

  const visitorId = getVisitorId()
  const today = new Date().toISOString().split('T')[0]

  const { data: existing } = await supabase.from('preview_listeners')
    .select('*').eq('preview_id', previewId).eq('visitor_id', visitorId)
    .eq('action_type', action).gte('created_at', `${today}T00:00:00`).maybeSingle()

  if (existing) return

  await supabase.from('preview_listeners').insert({
    preview_id: previewId, visitor_id: visitorId, artist_id: artistId,
    action_type: action, created_at: new Date().toISOString()
  })

  const { count } = await supabase.from('preview_listeners').select('*', { count: 'exact', head: true }).eq('preview_id', previewId)
  const el = document.querySelector(`[data-preview-id="${previewId}"] .listener-count`)
  if (el) el.textContent = count || 0
  
  if (window.currentSession?.user?.id) setupAdvancedAnalytics(window.currentSession.user.id)
}

const setupAdvancedAnalytics = async (userId) => {
  const { data: previews } = await supabase.from('music_previews').select('id, platform, release_name, created_at').eq('user_id', userId).eq('is_active', true)
  const { data: listeners } = await supabase.from('preview_listeners').select('preview_id, action_type, created_at').eq('artist_id', userId)
  
  const platformCounts = { youtube: 0, instagram: 0, spotify: 0, apple_music: 0 }
  const platformActions = { youtube: { play: 0, click: 0 }, instagram: { play: 0, click: 0 }, spotify: { play: 0, click: 0 }, apple_music: { play: 0, click: 0 } }
  
  previews?.forEach(p => {
    const pListeners = listeners?.filter(l => l.preview_id === p.id) || []
    platformCounts[p.platform] = (platformCounts[p.platform] || 0) + pListeners.length
    pListeners.forEach(l => {
      if (l.action_type === 'play') platformActions[p.platform].play++
      else if (l.action_type === 'click') platformActions[p.platform].click++
    })
  })

  const last7Days = Array.from({ length: 7 }, (_, i) => {
    const d = new Date()
    d.setDate(d.getDate() - (6 - i))
    return d.toISOString().split('T')[0]
  })

  const dailyListeners = last7Days.map(date => listeners?.filter(l => l.created_at.startsWith(date)).length || 0)
  const dailyPlays = last7Days.map(date => listeners?.filter(l => l.created_at.startsWith(date) && l.action_type === 'play').length || 0)
  const dailyClicks = last7Days.map(date => listeners?.filter(l => l.created_at.startsWith(date) && l.action_type === 'click').length || 0)

  renderCharts(platformCounts, last7Days, dailyListeners, dailyPlays, dailyClicks, listeners || [], previews || [])
}

const renderCharts = (platformCounts, labels, dailyListeners, dailyPlays, dailyClicks, listeners, previews) => {
  // Platform Chart
  const ctx1 = document.getElementById('platformChart')
  if (ctx1) {
    if (analyticsCharts.platform) analyticsCharts.platform.destroy()
    analyticsCharts.platform = new Chart(ctx1, {
      type: 'doughnut',
      data: {
        labels: ['YouTube', 'Instagram', 'Spotify', 'Apple Music'],
        datasets: [{ data: [platformCounts.youtube, platformCounts.instagram, platformCounts.spotify, platformCounts.apple_music], backgroundColor: ['#FF0000', '#E4405F', '#1DB954', '#ffffff'], borderWidth: 0 }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } }, title: { display: true, text: 'Listeners by Platform', color: '#fff' } } }
    })
  }

  // Timeline Chart
  const ctx2 = document.getElementById('timelineChart')
  if (ctx2) {
    if (analyticsCharts.timeline) analyticsCharts.timeline.destroy()
    analyticsCharts.timeline = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: labels.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
        datasets: [
          { label: 'Total Listeners', data: dailyListeners, borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', tension: 0.4, fill: true },
          { label: 'Audio Plays', data: dailyPlays, borderColor: '#1DB954', backgroundColor: 'rgba(29, 185, 84, 0.1)', tension: 0.4, fill: true },
          { label: 'Link Clicks', data: dailyClicks, borderColor: '#E4405F', backgroundColor: 'rgba(228, 64, 95, 0.1)', tension: 0.4, fill: true }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: 'rgba(255, 255, 255, 0.05)' } }, x: { ticks: { color: '#888' } } } }
    })
  }

  // Engagement Stats
  const container = document.getElementById('engagementStats')
  if (container) {
    const totalListeners = listeners.length
    const uniqueVisitors = new Set(listeners.map(l => l.visitor_id)).size
    const avgListenersPerRelease = previews.length > 0 ? (totalListeners / previews.length).toFixed(1) : 0
    const totalPlays = listeners.filter(l => l.action_type === 'play').length
    const totalClicks = listeners.filter(l => l.action_type === 'click').length
    
    container.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 20px;">
        ${[
          { icon: 'ri-user-line', value: totalListeners, label: 'Total Listeners' },
          { icon: 'ri-team-line', value: uniqueVisitors, label: 'Unique Visitors' },
          { icon: 'ri-bar-chart-box-line', value: avgListenersPerRelease, label: 'Avg Per Release' },
          { icon: 'ri-play-circle-line', value: totalPlays, label: 'Total Plays' },
          { icon: 'ri-links-line', value: totalClicks, label: 'Link Clicks' },
          { icon: 'ri-music-2-line', value: previews.length, label: 'Active Releases' }
        ].map(stat => `
          <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: var(--brand); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white;">
              <i class="${stat.icon}"></i>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: white;">${stat.value}</div>
              <div style="font-size: 11px; color: #999; margin-top: 2px;">${stat.label}</div>
            </div>
          </div>
        `).join('')}
      </div>
    `
  }
}

// Platform Config
const platformConfig = {
  youtube: { icon: 'ri-youtube-fill', name: 'YouTube', color: '#FF0000' },
  instagram: { icon: 'ri-instagram-fill', name: 'Instagram', color: '#E4405F' },
  spotify: { icon: 'ri-spotify-fill', name: 'Spotify', color: '#1DB954' },
  apple_music: { icon: 'ri-apple-fill', name: 'Apple Music', color: '#ffffff' }
}

// Audio Player
const initAudioPlayer = (container, previewId) => {
  const player = container.querySelector('.custom-audio-player')
  if (!player) return

  const audio = player.querySelector('audio')
  const btn = player.querySelector('.play-pause-btn')
  const icon = btn.querySelector('i')
  const time = player.querySelector('.time-display')
  const progress = player.querySelector('.progress-overlay')

  let tracked = false
  btn.onclick = async () => {
    if (audio.paused) {
      document.querySelectorAll('audio').forEach(a => {
        if (a !== audio) {
          a.pause()
          a.closest('.custom-audio-player')?.querySelector('.play-pause-btn i')?.setAttribute('class', 'ri-play-fill play-icon')
        }
      })
      audio.play()
      icon.className = 'ri-pause-fill play-icon'
      if (!tracked && window.currentSession?.user?.id) {
        await trackListener(previewId, 'play', window.currentSession.user.id)
        tracked = true
      }
    } else {
      audio.pause()
      icon.className = 'ri-play-fill play-icon'
    }
  }

  audio.ontimeupdate = () => {
    time.textContent = `${formatTime(Math.floor(audio.currentTime))} / ${formatTime(Math.floor(audio.duration)||0)}`
    progress.style.width = ((audio.currentTime / audio.duration) * 100) + '%'
  }

  audio.onended = () => {
    icon.className = 'ri-play-fill play-icon'
    progress.style.width = '0%'
  }
}

// Load Previews
const loadPreviews = async (userId) => {
  const container = document.getElementById('releasesContainer')
  if (!container) return

  window.currentUserLimits = await checkUserLimits(userId)
  const { data: previews } = await supabase.from('music_previews').select('*').eq('user_id', userId).eq('is_active', true).order('created_at', { ascending: false })

  if (!previews?.length) {
    container.innerHTML = `
      <div class="span-12 no-releases-container">
        <div class="no-releases-content">
          <img src="pro.svg" alt="No Releases" class="no-releases-image" />
          <h3 class="no-releases-title">No Releases Yet</h3>
          <p class="no-releases-text">Start sharing your music by adding your first release above.</p>
        </div>
      </div>
    `
    return
  }

  const links = await getSocialLinks(userId)
  const grouped = previews.reduce((acc, p) => ({ ...acc, [p.platform]: [...(acc[p.platform]||[]), p] }), {})
  container.innerHTML = ''

  Object.entries(grouped).forEach(([platform, items]) => {
    const cfg = platformConfig[platform]
    const section = document.createElement('div')
    section.className = 'posts span-4'
    section.innerHTML = `
      <div class="platform-section-header">
        <div class="post-header platform-post-header">
          <div class="post-header-left">
            <span><i class="${cfg.icon} ri-xl" style="color:${cfg.color};"></i></span>
            <div class="post-header-info"><strong>${cfg.name}</strong></div>
          </div>
        </div>
      </div>
      <section class="grid-12 platform-releases-grid"></section>
    `

    const grid = section.querySelector('.platform-releases-grid')
    items.forEach(p => {
      const canEdit = isPro || window.currentUserLimits?.edits_remaining > 0
      grid.insertAdjacentHTML('beforeend', `
        <div class="span-12 preview-card" data-preview-id="${p.id}">
          <div class="my-post-card">
            <div class="post-header post-header-dark">
              <div class="post-header-left">
                <img src="${p.thumbnail_url || window.currentUser?.profile_picture || 'user.webp'}" class="preview-thumbnail">
                <div class="post-header-info">
                  <strong>${window.currentUser?.stage_name || 'Artist'}</strong>
                  <div class="muted"><a href="${p.release_url}" target="_blank">View release</a></div>
                </div>
              </div>
              <div class="post-header-right">
                ${canEdit ? `<button class="btn ghost edit-preview-btn" data-preview-id="${p.id}"><i class="ri-edit-line ri-xl"></i></button>` : ''}
                <button class="btn ghost delete-preview-btn" data-preview-id="${p.id}"><i class="ri-delete-bin-line ri-xl"></i></button>
              </div>
            </div>
            ${p.preview_audio_url ? `
              <div class="d-post-body audio-preview-body">
                <div class="custom-audio-player" data-preview-id="${p.id}">
                  <audio style="display:none;"><source src="${p.preview_audio_url}"></audio>
                  <div class="audio-controls">
                    <button class="play-pause-btn"><i class="ri-play-fill play-icon"></i></button>
                    <div class="audio-info">
                      <div class="audio-title">${p.release_name}</div>
                    </div>
                    <div class="time-display">0:00 / ${formatTime(p.duration_seconds||0)}</div>
                  </div>
                  <div class="progress-overlay"></div>
                </div>
              </div>
            ` : `<div class="d-post-body">${p.release_name}</div>`}
            <div class="row preview-stats">
              <div class="col-4"><div class="muted t-s">Listeners</div><div class="listener-count">0</div></div>
              <div class="col-4"><div class="muted t-s">Duration</div><div>${formatTime(p.duration_seconds||0)}</div></div>
            </div>
          </div>
        </div>
      `)
      setTimeout(() => {
        const card = grid.querySelector(`[data-preview-id="${p.id}"]`)
        if (p.preview_audio_url) initAudioPlayer(card, p.id)
      }, 100)
    })

    container.appendChild(section)
  })

  previews.forEach(async p => {
    const { count } = await supabase.from('preview_listeners').select('*', { count: 'exact', head: true }).eq('preview_id', p.id)
    const el = document.querySelector(`[data-preview-id="${p.id}"] .listener-count`)
    if (el) el.textContent = count || 0
  })
}

// Form Setup
const setupForm = (session) => {
  const form = document.getElementById('uploadForm')
  let selectedFile = null
  let selectedPlatform = null

  form?.addEventListener('submit', async (e) => {
    e.preventDefault()
    const submitBtn = document.getElementById('uSubmit')
    
    if (!selectedPlatform) return notify('Select a platform', '#ef4444')

    const check = await canUpload(session.user.id, 'release')
    if (!check.allowed) {
      if (check.showUpgrade) showPremiumBottomSheet()
      return notify(check.message, '#ef4444')
    }

    submitBtn.disabled = true
    submitBtn.innerHTML = '<i class="ri-loader-4-line"></i> Uploading...'

    try {
      let audioData = null
      if (selectedFile) {
        audioData = await uploadAudio(selectedFile, session)
      }

      await supabase.from('music_previews').insert({
        user_id: session.user.id,
        platform: selectedPlatform,
        release_name: document.getElementById('uTags').value,
        release_url: document.getElementById('uBpm').value,
        preview_audio_url: audioData?.url,
        duration_seconds: audioData?.duration,
        thumbnail_url: window.currentUser?.profile_picture,
        is_active: true
      })

      notify('Release uploaded!', '#10b981')
      form.reset()
      await loadPreviews(session.user.id)

    } catch (error) {
      notify(error.message, '#ef4444')
    } finally {
      submitBtn.disabled = false
      submitBtn.innerHTML = '<i class="ri-upload-2-line"></i> Upload'
    }
  })
}

// Delete Handlers
const setupDeleteHandlers = (session) => {
  document.addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.delete-preview-btn')
    if (deleteBtn && await confirm('Delete this release?')) {
      await supabase.from('music_previews').update({ is_active: false }).eq('id', deleteBtn.dataset.previewId)
      notify('Release deleted', '#10b981')
      await loadPreviews(session.user.id)
    }
  })
}

// Initialize
const init = async () => {
  try {
    const { session } = await initAuth()
    if (!session) return

    await checkProExpiration(session.user.id)
    await Promise.all([loadPreviews(session.user.id), setupAdvancedAnalytics(session.user.id)])
    
    setupForm(session)
    setupDeleteHandlers(session)
    
    document.querySelector('.logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut()
      window.location.href = 'register'
    })

  } catch (error) {
    console.error('Init error:', error)
    notify('Failed to load dashboard', '#ef4444')
  }
}

init()
</script>


<script>
document.addEventListener("click", e => {
  if (e.target.closest(".link-1")) {
    document.getElementById("linkModal").classList.remove("hidden");
  }
  if (e.target.closest("#linkClose") || e.target.id === "linkModal") {
    document.getElementById("linkModal").classList.add("hidden");
  }
  if (e.target.closest(".limitModalBtn")) {
    document.getElementById("limitModal").classList.remove("hidden");
  }
  if (e.target.closest("#limitClose") || e.target.id === "limitModal") {
    document.getElementById("limitModal").classList.add("hidden");
  }
});

document.querySelectorAll('.custom-select').forEach(select => {
  const selected = select.querySelector('.select-selected');
  const options = select.dataset.options.split(',');

  const dropdown = document.createElement('div');
  dropdown.classList.add('select-items-portal');
  options.forEach(opt => {
    const div = document.createElement('div');
    div.textContent = opt;
    dropdown.appendChild(div);

    div.addEventListener('click', e => {
      e.stopPropagation();
      selected.textContent = opt;
      dropdown.classList.remove('show');
      selected.classList.remove('active');
    });
  });
  document.body.appendChild(dropdown);

  selected.addEventListener('click', e => {
    e.stopPropagation();

    const rect = selected.getBoundingClientRect();
    dropdown.style.top = `${rect.bottom + window.scrollY}px`;
    dropdown.style.left = `${rect.left + window.scrollX}px`;
    dropdown.style.width = `${rect.width}px`;

    document.querySelectorAll('.select-items-portal.show').forEach(other => {
      if (other !== dropdown) {
        other.classList.remove('show');
        other.previousSelected?.classList.remove('active');
      }
    });

    dropdown.classList.toggle('show');
    selected.classList.toggle('active');
    dropdown.previousSelected = selected;
  });
});

document.addEventListener('click', () => {
  document.querySelectorAll('.select-items-portal.show').forEach(dropdown => {
    dropdown.classList.remove('show');
    dropdown.previousSelected?.classList.remove('active');
  });
});

['scroll','resize'].forEach(ev => {
  window.addEventListener(ev, () => {
    document.querySelectorAll('.select-items-portal.show').forEach(dropdown => {
      const selected = dropdown.previousSelected;
      if (!selected) return;
      const rect = selected.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.width = `${rect.width}px`;
    });
  });
});
</script>
</body>
</html>

