<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="logo.png" type="image/x-icon">
<meta name="theme-color" content="#000000">
<title>VYNAL Premium - Pro Dashboard</title>
<link rel="stylesheet" href="remixicon.min.css">
<link rel="stylesheet" href="pro.css">
<link rel="stylesheet" href="inter.css">
<script src="https://www.paypal.com/sdk/js?client-id=AUOquOrBAj4hRVIlyydpdK_tKcmG4AN_o8IK3Tu1b9d8R24o3f9Wm1NsONdMBvTY3hCxniqU0WRiZAom&currency=USD"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
/* Access Blocker Overlay */
.access-blocker {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #000000;
  z-index: 9999;
  display: none;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.4s ease;
}

.access-blocker.active {
  display: flex;
  opacity: 1;
}

.access-blocker-content {
  text-align: center;
  max-width: 500px;
  padding: 40px;
  animation: slideUp 0.5s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.access-blocker-icon {
  width: 100px;
  height: 100px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 30px;
  font-size: 48px;
  color: #000000;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.access-blocker-title {
  font-size: 32px;
  font-weight: 800;
  color: white;
  margin: 0 0 16px 0;
}

.access-blocker-subtitle {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.7);
  margin: 0 0 32px 0;
  line-height: 1.6;
}

.access-blocker-btn {
  background: white;
  color: #000000;
  border: none;
  border-radius: 12px;
  padding: 18px 48px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
}

.access-blocker-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(255, 255, 255, 0.4);
}

/* Bottom Sheet Premium Modal */
.premium-bottom-sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #ffffff;
  border-radius: 24px 24px 0 0;
  z-index: 10001;
  max-height: 90vh;
  overflow-y: auto;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.3);
}

.premium-bottom-sheet.active {
  transform: translateY(0);
}

.premium-sheet-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(5px);
  z-index: 10000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.premium-sheet-overlay.active {
  opacity: 1;
  pointer-events: all;
}

.sheet-handle {
  width: 40px;
  height: 4px;
  background: #e0e0e0;
  border-radius: 2px;
  margin: 12px auto 0;
}

.sheet-content {
  padding: 24px 24px 40px;
}

.sheet-header {
  text-align: center;
  margin-bottom: 32px;
}

.premium-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: #000000;
  padding: 8px 20px;
  border-radius: 50px;
  font-size: 14px;
  font-weight: 600;
  color: white;
  margin-bottom: 16px;
}

.premium-title {
  font-size: 36px;
  font-weight: 800;
  color: #000000;
  margin: 0 0 12px 0;
  line-height: 1.1;
}

.premium-subtitle {
  font-size: 16px;
  color: #666666;
  margin: 0;
  line-height: 1.6;
}

.premium-features {
  display: grid;
  gap: 12px;
  margin: 32px 0;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 16px;
  background: #f5f5f5;
  padding: 16px;
  border-radius: 12px;
  transition: all 0.3s ease;
}

.feature-item:hover {
  background: #eeeeee;
  transform: translateX(4px);
}

.feature-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: #000000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  flex-shrink: 0;
}

.feature-text {
  flex: 1;
}

.feature-title {
  font-size: 16px;
  font-weight: 700;
  color: #000000;
  margin: 0 0 4px 0;
}

.feature-desc {
  font-size: 13px;
  color: #666666;
  margin: 0;
}

.premium-pricing {
  background: #000000;
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  margin: 24px 0;
}

.premium-price {
  font-size: 48px;
  font-weight: 900;
  color: white;
  line-height: 1;
  margin: 0;
}

.premium-price-suffix {
  font-size: 18px;
  color: rgba(255, 255, 255, 0.9);
  margin-left: 8px;
}

.premium-price-note {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.8);
  margin: 8px 0 0 0;
}

.premium-cta-btn {
  width: 100%;
  background: #000000;
  color: white;
  border: none;
  border-radius: 12px;
  padding: 18px 32px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.premium-cta-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
  background: #1a1a1a;
}

.premium-cta-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.premium-cta-btn i {
  font-size: 22px;
}

.premium-note {
  text-align: center;
  font-size: 13px;
  color: #999999;
  margin-top: 16px;
}

.pro-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #000000;
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 8px;
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.limits-header.pro-user {
  background: #000000;
  color: white;
}

.user-limits-card.pro-user {
  border: 2px solid #000000;
}

.limit-item.unlimited .limit-value {
  color: #000000;
  font-weight: 700;
}

.limit-item.unlimited .limit-progress-bar {
  background: #000000;
  width: 100% !important;
}

/* Enhanced Scrollbar */
.premium-bottom-sheet::-webkit-scrollbar {
  width: 8px;
}

.premium-bottom-sheet::-webkit-scrollbar-track {
  background: #f5f5f5;
  border-radius: 4px;
}

.premium-bottom-sheet::-webkit-scrollbar-thumb {
  background: #cccccc;
  border-radius: 4px;
}

.premium-bottom-sheet::-webkit-scrollbar-thumb:hover {
  background: #999999;
}

/* Blur Dashboard Content */
.main.blurred {
  filter: blur(8px);
  pointer-events: none;
  user-select: none;
}

.aside.blurred,
.header.blurred {
  filter: blur(8px);
  pointer-events: none;
}
</style>
</head>
<body>

<!-- Access Blocker for Non-Pro Users -->
<div class="access-blocker" id="accessBlocker">
  <div class="access-blocker-content">
    <div class="access-blocker-icon">
      <i class="ri-lock-fill"></i>
    </div>
    <h1 class="access-blocker-title">Pro Dashboard Access</h1>
    <p class="access-blocker-subtitle">This advanced analytics dashboard is exclusively available for VYNAL Pro members. Upgrade now to unlock unlimited features and insights.</p>
    <button class="access-blocker-btn" id="accessBlockerUpgradeBtn">
      <i class="ri-vip-crown-fill"></i>
      Upgrade to Pro
    </button>
  </div>
</div>

<!-- Premium Bottom Sheet -->
<div class="premium-sheet-overlay" id="premiumSheetOverlay"></div>
<div class="premium-bottom-sheet" id="premiumBottomSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-content">
    <div class="sheet-header">
      <div class="premium-badge">
        <i class="ri-vip-crown-fill"></i>
        VYNAL Pro
      </div>
      <h1 class="premium-title">Upgrade to Pro</h1>
      <p class="premium-subtitle">Unlock unlimited releases, advanced analytics, and exclusive features to grow your music career.</p>
    </div>

    <div class="premium-features">
      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-infinite-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Unlimited Releases</h3>
          <p class="feature-desc">Share as many tracks as you want across all platforms</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-headphone-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Unlimited Audio Previews</h3>
          <p class="feature-desc">Add audio previews to every release without limits</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-edit-2-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Unlimited Edits</h3>
          <p class="feature-desc">Update and refine your releases anytime</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-bar-chart-box-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Advanced Analytics</h3>
          <p class="feature-desc">Deep insights into listener behavior and engagement</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-customer-service-2-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Priority Support</h3>
          <p class="feature-desc">Get help faster with dedicated support</p>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">
          <i class="ri-flashlight-fill"></i>
        </div>
        <div class="feature-text">
          <h3 class="feature-title">Early Access</h3>
          <p class="feature-desc">Be first to try new features and tools</p>
        </div>
      </div>
    </div>

    <div class="premium-pricing">
      <div class="premium-price">$9.99<span class="premium-price-suffix">/month</span></div>
      <p class="premium-price-note">Cancel anytime. No hidden fees.</p>
    </div>

    <button class="premium-cta-btn" id="upgradeToPro">
      <i class="ri-vip-crown-fill"></i>
      Start Pro Membership
    </button>

    <p class="premium-note">âœ¨ Join thousands of artists growing their careers with VYNAL Pro</p>
  </div>
</div>

<aside class="aside" aria-label="Sidebar">
<div class="brand"><span><img src="pro.svg" width="300"></span></div>
<div class="side-group">
<div class="side-label">Main</div>
<nav class="nav" aria-label="Primary">
<a href="/dashboard"><i class="ri-stack-fill"></i><span>Feed</span></a>
<a href="/debates"><i class="ri-compass-2-line"></i><span>Debates</span></a>
<a href="/mall" data-link><i class="ri-shopping-bag-line"></i><span>Mi-mall</span></a>
<a href="/events" data-link><i class="ri-ticket-2-line"></i><span>Mi-events</span></a>
<a href="#" class="active" data-link><i class="ri-filter-3-line"></i><span>Pro.</span></a>
</nav>
</div>
<div class="side-group">
<div class="side-label">Account</div>
<nav class="nav" aria-label="Secondary">
<a href="/account"><i class="ri-user-3-line"></i><span>Profile</span></a>
<a href="/account-settings"><i class="ri-settings-3-line"></i><span>Settings</span></a>
<a class="logout-btn"><i class="ri-logout-box-r-line"></i><span>Logout</span></a>
</nav>
</div>
</aside>

<header class="header" role="banner" style="padding: 10px 0;">
<div class="moblogo">
<span><img src="pro.svg" width="80"></span>
</div>
<div class="searchbar">
</div>
<div class="actions">
<div class="limit">
<button class="btn ghost upgrade-to-pro-btn" style="border:0; margin:0 -15px;background:none;color:grey;"><i class="ri-vip-crown-line t-l"></i></button>
<span class="limited-lock m-t7 m-r-5" style="color: grey;background: black;"><i class="ri-lock-line"></i></span>
</div>
<button class="btn-icon limitModalBtn" aria-label="create" style="margin-right: 5px;border: none;color:white;background:var(--brand);font-size: 20px;padding: 0 20px;"><i class="ri-pie-chart-line"></i></button>
<a><img class="avatar uploading" src="user.webp"></a>
</div>
</header>

<main class="main">
<section class="grid-12">
<div class="artist span-4" id="artistCard">
<span class="artist__label"></span>
<h1 class="artist__name"></h1>
<div class="artist__icons"></div>
</div>

<div class="card span-5" data-animate>
<h2>Add New Release Link</h2>
<form id="uploadForm" class="upload" novalidate>
<div class="row">
<div class="col-6">
<div class="custom-select" data-options="Youtube,Instagram,Spotify,Apple Music">
  <div class="select-selected">Select Platform</div>
</div>
</div>
<div class="col-6"><input class="input" style="background: none;color: white;" type="text" id="uDesc" placeholder="Platform @username"></div>
</div>
<div class="row">
<div class="col-8"><input class="input" style="background: none;color: white;" type="text" id="uTags" placeholder="Release Name"></div>
<div class="col-4"><input class="input" style="background: none;color: white;" type="text" id="uBpm" placeholder="Url"></div>
</div>
<div class="dropzone" id="dropAudio" aria-label="Audio dropzone">
<i class="ri-upload-cloud-2-line"></i> Drop audio file preview here or <u>browse</u>
<input id="uFile" type="file" accept="audio/*" class="sr-only" />
</div>
<span style="text-align: center;">* allowed .mp3 only 1:00 minute</span>
<div style="display:flex; gap:8px; justify-content:flex-end;">
<button type="button" class="btn ghost" id="uReset"><i class="ri-restart-line"></i> Reset</button>
<button class="btn primary" id="uSubmit" type="submit"><i class="ri-upload-2-line"></i> Upload</button>
</div>
</form>
</div>
<div class="chart-container span-3">
<canvas id="platformChart"></canvas>
</div>
</section>

<section class="grid-12">
  <div class="chart-container span-3">
    <canvas id="timelineChart"></canvas>
  </div>
  <div class="chart-container span-3">
    <canvas id="actionChart"></canvas>
  </div>
  <div class="chart-container span-3">
    <canvas id="platformActionChart"></canvas>
  </div>
  <div class="chart-container span-3">
    <canvas id="topReleasesChart"></canvas>
  </div>
</section>

<section class="grid-12">
<div class="span-12" id="engagementStats"></div>
</section>

<div class="modal-backdrop hidden" id="limitModal">
<div class="modal" role="document" style="max-width: 700px;background: transparent;">
<div style="display:flex; align-items:center; justify-content:space-between;">
<strong style="color: black;"></strong>
<button class="btn-icon" id="limitClose" style="color: rgb(255, 255, 255);"><i class="ri-close-line ri-xl"></i></button>
</div>
<div class="divider"></div>
<div class="user-limits-card">
  <div class="limits-header">
    <i class="ri-pie-chart-line"></i>
    <h3>Your Plan Limits</h3>
  </div>
  
  <div class="limits-grid">
    <div class="limit-item">
      <div class="limit-icon-wrapper">
        <i class="ri-music-2-fill limit-icon"></i>
      </div>
      <div class="limit-info">
        <div class="limit-label">Releases</div>
        <div class="release-limit-display limit-value">0/6</div>
      </div>
      <div class="limit-progress">
        <div class="limit-progress-bar release-progress"></div>
      </div>
    </div>
    
    <div class="limit-item">
      <div class="limit-icon-wrapper">
        <i class="ri-headphone-fill limit-icon"></i>
      </div>
      <div class="limit-info">
        <div class="limit-label">Audio Previews</div>
        <div class="audio-limit-display limit-value">0/10</div>
      </div>
      <div class="limit-progress">
        <div class="limit-progress-bar audio-progress"></div>
      </div>
    </div>
    
    <div class="limit-item">
      <div class="limit-icon-wrapper">
        <i class="ri-edit-2-fill limit-icon"></i>
      </div>
      <div class="limit-info">
        <div class="limit-label">Edits</div>
        <div class="edits-limit-display limit-value">1 remaining</div>
      </div>
      <div class="limit-progress">
        <div class="limit-progress-bar edits-progress"></div>
      </div>
    </div>
  </div>
  
  <div class="limits-footer" id="limitsFooter">
    <i class="ri-information-line"></i>
    <span>Upgrade to Pro for unlimited releases, audio previews, and edits</span>
  </div>
</div>
</div>
</div>

<section class="grid-12" id="releasesContainer"></section>
</main>

<div class="space"></div>

<div class="modal-backdrop hidden" id="linkModal">
<div class="modal" role="document">
<div style="display:flex; align-items:center; justify-content:space-between;">
<strong style="color: black;">Share Post</strong>
<button class="btn-icon" id="linkClose" style="color: black;"><i class="ri-close-line"></i></button>
</div>
<div class="divider"></div>
<div style="display:grid; gap:10px; margin-top:10px;">
<button class="btn ghost"><i class="ri-link"></i> Copy Link</button>
<button class="btn ghost"><i class="ri-twitter-line"></i> Share to Twitter</button>
<button class="btn ghost"><i class="ri-facebook-circle-line"></i> Share to Facebook</button>
<button class="btn ghost"><i class="ri-telegram-line"></i> Share to Telegram</button>
</div>
</div>
</div>

<script type="module">
  import { supabase } from './supabase-client.js'

let isPro = false
let analyticsCharts = {}

const notify = (message, color = '#10b981') => {
  const modal = document.createElement('div')
  modal.className = 'notification-modal-overlay'
  
  const iconMap = {
    '#10b981': 'ri-checkbox-circle-fill',
    '#ef4444': 'ri-error-warning-fill',
    '#3b82f6': 'ri-information-fill',
    '#f59e0b': 'ri-alert-fill'
  }
  
  const icon = iconMap[color] || 'ri-checkbox-circle-fill'
  
  modal.innerHTML = `
    <div class="notification-modal-content">
      <i class="${icon} notification-modal-icon" style="color: ${color}"></i>
      <p class="notification-modal-message">${message}</p>
      <button class="notification-modal-btn">OK</button>
    </div>
  `
  
  document.body.appendChild(modal)
  setTimeout(() => modal.classList.add('active'), 10)
  
  const closeModal = () => {
    modal.classList.remove('active')
    setTimeout(() => modal.remove(), 300)
  }
  
  modal.querySelector('.notification-modal-btn').addEventListener('click', closeModal)
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal()
  })
  
  setTimeout(closeModal, 3000)
}

const confirm = (message) => {
  return new Promise((resolve) => {
    const modal = document.createElement('div')
    modal.className = 'confirm-modal-overlay'
    
    modal.innerHTML = `
      <div class="confirm-modal-content">
        <i class="ri-alert-fill confirm-modal-icon"></i>
        <h3 class="confirm-modal-title">Confirm Action</h3>
        <p class="confirm-modal-message">${message}</p>
        <div class="confirm-modal-actions">
          <button class="confirm-modal-btn confirm-cancel">Cancel</button>
          <button class="confirm-modal-btn confirm-delete">Confirm</button>
        </div>
      </div>
    `
    
    document.body.appendChild(modal)
    setTimeout(() => modal.classList.add('active'), 10)
    
    const closeModal = (result) => {
      modal.classList.remove('active')
      setTimeout(() => {
        modal.remove()
        resolve(result)
      }, 300)
    }
    
    modal.querySelector('.confirm-cancel').addEventListener('click', () => closeModal(false))
    modal.querySelector('.confirm-delete').addEventListener('click', () => closeModal(true))
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal(false)
    })
  })
}

const formatTime = (s) => `${Math.floor(s/60)}`.padStart(2,'0')+':'+`${s%60}`.padStart(2,'0')

const showPremiumBottomSheet = () => {
  const overlay = document.getElementById('premiumSheetOverlay')
  const sheet = document.getElementById('premiumBottomSheet')
  
  overlay.classList.add('active')
  setTimeout(() => sheet.classList.add('active'), 10)
}

const hidePremiumBottomSheet = () => {
  const overlay = document.getElementById('premiumSheetOverlay')
  const sheet = document.getElementById('premiumBottomSheet')
  
  sheet.classList.remove('active')
  setTimeout(() => overlay.classList.remove('active'), 400)
}

document.getElementById('premiumSheetOverlay').addEventListener('click', hidePremiumBottomSheet)

document.addEventListener('click', (e) => {
  if (e.target.closest('.upgrade-to-pro-btn') || e.target.closest('.upgrade-prompt-btn')) {
    showPremiumBottomSheet()
  }
})

document.getElementById('accessBlockerUpgradeBtn').addEventListener('click', showPremiumBottomSheet)

document.getElementById('upgradeToPro').addEventListener('click', async () => {
  if (!window.currentSession) return
  
  // Hide the upgrade button temporarily and show PayPal button
  const upgradeBtn = document.getElementById('upgradeToPro')
  upgradeBtn.style.display = 'none'
  
  // Create PayPal button container if it doesn't exist
  let paypalContainer = document.getElementById('paypal-button-container')
  if (!paypalContainer) {
    paypalContainer = document.createElement('div')
    paypalContainer.id = 'paypal-button-container'
    upgradeBtn.parentNode.insertBefore(paypalContainer, upgradeBtn.nextSibling)
  }
  
  // Render PayPal button
  paypal.Buttons({
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: '4.99',
            currency_code: 'USD'
          },
          description: 'Pro Membership - Music Preview Platform'
        }]
      })
    },
    onApprove: async function(data, actions) {
      return actions.order.capture().then(async function(details) {
        // Payment successful, upgrade user
        try {
          const { error } = await supabase
            .from('profiles')
            .update({ 
              tier: 'pro',
              payment_id: details.id,
              upgraded_at: new Date().toISOString()
            })
            .eq('id', window.currentSession.user.id)
          
          if (error) throw error
          
          notify('ðŸŽ‰ Payment successful! Upgrading to Pro...', '#10b981')
          setTimeout(() => window.location.reload(), 1500)
          
        } catch (error) {
          notify('Upgrade failed. Please contact support.', '#ef4444')
          console.error('Upgrade error:', error)
        }
      })
    },
    onError: function(err) {
      notify('Payment failed. Please try again.', '#ef4444')
      console.error('PayPal error:', err)
      upgradeBtn.style.display = 'block'
      paypalContainer.innerHTML = ''
    },
    onCancel: function() {
      notify('Payment cancelled', '#f59e0b')
      upgradeBtn.style.display = 'block'
      paypalContainer.innerHTML = ''
    }
  }).render('#paypal-button-container')
})

const initAuth = async () => {
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) return window.location.href = 'register'

  const { data: profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single()
  
  window.currentUser = profile
  window.currentSession = session
  isPro = profile.tier === 'pro'
  
  if (!isPro) {
    document.getElementById('accessBlocker').classList.add('active')
    document.querySelector('.main').classList.add('blurred')
    document.querySelector('.aside').classList.add('blurred')
    document.querySelector('.header').classList.add('blurred')
  } else {
    document.getElementById('accessBlocker').remove()
  }
  
  document.querySelectorAll('.artist__name, .user-name').forEach(el => {
    el.innerHTML = (profile.stage_name || 'Artist') + (isPro ? '<span class="pro-badge"><i class="ri-vip-crown-fill"></i>PREMIUM</span>' : '')
  })
  document.querySelectorAll('.profile-picture, .uploading').forEach(el => el.src = profile.profile_picture || 'user.webp')
  document.querySelectorAll('.artist__label').forEach(el => el.textContent = profile.role || 'Artist')
  
  const card = document.getElementById('artistCard')
  if (card && profile.profile_picture) {
    card.style.backgroundImage = `url('${profile.profile_picture}')`
    card.style.backgroundSize = 'cover'
    card.style.backgroundPosition = 'center'
  }
  
  if (isPro) {
    document.querySelector('.upgrade-to-pro-btn')?.remove()
    document.querySelector('.limited-lock')?.remove()
    document.querySelectorAll('.user-limits-card').forEach(el => el.classList.add('pro-user'))
    document.querySelectorAll('.limits-header').forEach(el => el.classList.add('pro-user'))
    
    const footer = document.getElementById('limitsFooter')
    if (footer) {
      footer.innerHTML = '<i class="ri-vip-crown-fill" style="color:#000000"></i><span style="color:#000000;font-weight:700">PRO Plan Active - Unlimited Everything!</span>'
    }
    
    const blocker = document.getElementById('accessBlocker')
    if (blocker) blocker.remove()
    document.querySelector('.main')?.classList.remove('blurred')
    document.querySelector('.aside')?.classList.remove('blurred')
    document.querySelector('.header')?.classList.remove('blurred')
  }
  
  return { session, profile }
}

const checkUserLimits = async (userId) => {
  const { data: profile } = await supabase
    .from('profiles')
    .select('current_release_count, max_releases, current_audio_count, max_audio_previews, edits_remaining, tier, max_edits')
    .eq('id', userId)
    .single()
  
  if (profile.tier === 'pro') {
    return {
      ...profile,
      max_releases: 999999,
      max_audio_previews: 999999,
      edits_remaining: 999999,
      max_edits: 999999
    }
  }
  
  return profile
}

const canUpload = async (userId, type) => {
  if (isPro) return { allowed: true, message: 'Unlimited for PRO users' }
  
  const limits = await checkUserLimits(userId)
  
  if (type === 'release') {
    if (limits.current_release_count >= limits.max_releases) {
      return { 
        allowed: false, 
        message: `Release limit reached (${limits.max_releases} max). Upgrade to Pro for unlimited!`,
        showUpgrade: true
      }
    }
  }
  
  if (type === 'audio') {
    if (limits.current_audio_count >= limits.max_audio_previews) {
      return { 
        allowed: false, 
        message: `Audio preview limit reached (${limits.max_audio_previews} max). Upgrade to Pro!`,
        showUpgrade: true
      }
    }
  }
  
  if (type === 'edit') {
    if (limits.edits_remaining <= 0) {
      return { 
        allowed: false, 
        message: `Edit limit reached. Upgrade to Pro for unlimited edits!`,
        showUpgrade: true
      }
    }
  }
  
  return { allowed: true }
}

const uploadAudio = async (file, session) => {
  if (!file.type.startsWith('audio/')) throw new Error('Only audio files allowed')
  if (file.size > 3*1024*1024) throw new Error('Max 3MB')
  
  const check = await canUpload(session.user.id, 'audio')
  if (!check.allowed) {
    if (check.showUpgrade) showPremiumBottomSheet()
    throw new Error(check.message)
  }

  const audio = new Audio()
  const duration = await new Promise((res, rej) => {
    audio.src = URL.createObjectURL(file)
    audio.onloadedmetadata = () => {
      const dur = Math.floor(audio.duration)
      URL.revokeObjectURL(audio.src)
      dur > 60 ? rej(new Error('Max 60 seconds')) : res(dur)
    }
    audio.onerror = () => rej(new Error('Invalid audio'))
  })

  const fileName = `${session.user.id}/${Date.now()}.${file.name.split('.').pop()}`
  const { error } = await supabase.storage.from('audio-previews').upload(fileName, file, { cacheControl: '3600' })
  if (error) throw error

  const { data } = supabase.storage.from('audio-previews').getPublicUrl(fileName)
  return { url: data.publicUrl, duration }
}

const getSocialLinks = async (userId) => {
  const { data } = await supabase.from('user_social_links').select('*').eq('user_id', userId)
  return data?.reduce((acc, l) => ({ ...acc, [l.platform]: { username: l.username, url: l.profile_url, verified: l.is_verified } }), {}) || {}
}

const saveSocialLink = async (platform, username, url, userId) => {
  const { data: existing, error: selectError } = await supabase
    .from('user_social_links')
    .select('id')
    .eq('user_id', userId)
    .eq('platform', platform)
    .maybeSingle()

  if (selectError && selectError.code !== 'PGRST116') throw selectError

  if (existing) {
    const { error: updateError } = await supabase
      .from('user_social_links')
      .update({
        username,
        profile_url: url,
        updated_at: new Date().toISOString()
      })
      .eq('id', existing.id)
    
    if (updateError) throw updateError
  } else {
    const { error: insertError } = await supabase
      .from('user_social_links')
      .insert({
        user_id: userId,
        platform,
        username,
        profile_url: url,
        updated_at: new Date().toISOString()
      })
    
    if (insertError) throw insertError
  }
}

const getListenerCount = async (previewId) => {
  const { count } = await supabase.from('preview_listeners').select('*', { count: 'exact', head: true }).eq('preview_id', previewId)
  return count || 0
}

const getVisitorId = () => {
  let id = localStorage.getItem('vynal_visitor_id')
  if (!id) {
    id = `visitor_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    localStorage.setItem('vynal_visitor_id', id)
  }
  return id
}

const trackListener = async (previewId, action, artistId) => {
  if (!artistId || !previewId || window.currentSession?.user?.id === artistId) return

  const visitorId = getVisitorId()
  const today = new Date().toISOString().split('T')[0]

  const { data: existing } = await supabase.from('preview_listeners')
    .select('*').eq('preview_id', previewId).eq('visitor_id', visitorId)
    .eq('action_type', action).gte('created_at', `${today}T00:00:00`).maybeSingle()

  if (existing) return

  await supabase.from('preview_listeners').insert({
    preview_id: previewId, visitor_id: visitorId, artist_id: artistId,
    action_type: action, created_at: new Date().toISOString()
  })

  const count = await getListenerCount(previewId)
  const el = document.querySelector(`[data-preview-id="${previewId}"] .listener-count`)
  if (el) el.textContent = count
  
  if (window.currentSession?.user?.id) setupAdvancedAnalytics(window.currentSession.user.id)
}

const getAnalyticsData = async (userId) => {
  const { data: previews } = await supabase
    .from('music_previews')
    .select('id, platform, release_name, created_at')
    .eq('user_id', userId)
    .eq('is_active', true)

  const { data: listeners } = await supabase
    .from('preview_listeners')
    .select('preview_id, action_type, created_at')
    .eq('artist_id', userId)

  return { previews: previews || [], listeners: listeners || [] }
}

const setupAdvancedAnalytics = async (userId) => {
  const { previews, listeners } = await getAnalyticsData(userId)
  
  const platformCounts = { youtube: 0, instagram: 0, spotify: 0, apple_music: 0 }
  const platformActions = { 
    youtube: { play: 0, click: 0 }, 
    instagram: { play: 0, click: 0 }, 
    spotify: { play: 0, click: 0 }, 
    apple_music: { play: 0, click: 0 } 
  }
  
  previews.forEach(p => {
    const previewListeners = listeners.filter(l => l.preview_id === p.id)
    platformCounts[p.platform] = (platformCounts[p.platform] || 0) + previewListeners.length
    
    previewListeners.forEach(l => {
      if (l.action_type === 'play') platformActions[p.platform].play++
      else if (l.action_type === 'click') platformActions[p.platform].click++
    })
  })

  const last7Days = Array.from({ length: 7 }, (_, i) => {
    const d = new Date()
    d.setDate(d.getDate() - (6 - i))
    return d.toISOString().split('T')[0]
  })

  const dailyListeners = last7Days.map(date => {
    return listeners.filter(l => l.created_at.startsWith(date)).length
  })

  const dailyPlays = last7Days.map(date => {
    return listeners.filter(l => l.created_at.startsWith(date) && l.action_type === 'play').length
  })

  const dailyClicks = last7Days.map(date => {
    return listeners.filter(l => l.created_at.startsWith(date) && l.action_type === 'click').length
  })

  const totalPlays = listeners.filter(l => l.action_type === 'play').length
  const totalClicks = listeners.filter(l => l.action_type === 'click').length

  const releaseStats = previews.map(p => {
    const previewListeners = listeners.filter(l => l.preview_id === p.id)
    return {
      name: p.release_name,
      platform: p.platform,
      listeners: previewListeners.length,
      plays: previewListeners.filter(l => l.action_type === 'play').length,
      clicks: previewListeners.filter(l => l.action_type === 'click').length
    }
  }).sort((a, b) => b.listeners - a.listeners).slice(0, 5)

  renderPlatformChart(platformCounts)
  renderTimelineChart(last7Days, dailyListeners, dailyPlays, dailyClicks)
  renderActionChart(totalPlays, totalClicks)
  renderPlatformActionChart(platformActions)
  renderTopReleasesChart(releaseStats)
  renderEngagementStats(listeners, previews)
}

const renderPlatformChart = (platformCounts) => {
  const ctx = document.getElementById('platformChart')
  if (!ctx) return

  ctx.style.marginBottom = '30px'
  ctx.style.display = 'block'

  if (analyticsCharts.platform) analyticsCharts.platform.destroy()

  analyticsCharts.platform = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['YouTube', 'Instagram', 'Spotify', 'Apple Music'],
      datasets: [{
        data: [
          platformCounts.youtube,
          platformCounts.instagram,
          platformCounts.spotify,
          platformCounts.apple_music
        ],
        backgroundColor: ['#FF0000', '#E4405F', '#1DB954', '#ffffff'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      aspectRatio: 1.5,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#fff', padding: 15, font: { size: 12 } }
        },
        title: {
          display: true,
          text: 'Listeners by Platform',
          color: '#fff',
          font: { size: 16, weight: 'bold' },
          padding: { bottom: 20 }
        }
      }
    }
  })
}

const renderTimelineChart = (labels, listeners, plays, clicks) => {
  const ctx = document.getElementById('timelineChart')
  if (!ctx) return

  ctx.style.marginBottom = '30px'
  ctx.style.display = 'block'

  if (analyticsCharts.timeline) analyticsCharts.timeline.destroy()

  analyticsCharts.timeline = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
      datasets: [
        {
          label: 'Total Listeners',
          data: listeners,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'Audio Plays',
          data: plays,
          borderColor: '#1DB954',
          backgroundColor: 'rgba(29, 185, 84, 0.1)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'Link Clicks',
          data: clicks,
          borderColor: '#E4405F',
          backgroundColor: 'rgba(228, 64, 95, 0.1)',
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      aspectRatio: 2,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          position: 'top',
          labels: { color: '#fff', padding: 15, font: { size: 12 } }
        },
        title: {
          display: true,
          text: '7-Day Activity Trend',
          color: '#fff',
          font: { size: 16, weight: 'bold' },
          padding: { bottom: 20 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#888', stepSize: 1 },
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        },
        x: {
          ticks: { color: '#888' },
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        }
      }
    }
  })
}

const renderActionChart = (plays, clicks) => {
  const ctx = document.getElementById('actionChart')
  if (!ctx) return

  ctx.style.marginBottom = '30px'
  ctx.style.display = 'block'

  if (analyticsCharts.action) analyticsCharts.action.destroy()

  analyticsCharts.action = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Audio Plays', 'Link Clicks'],
      datasets: [{
        label: 'Actions',
        data: [plays, clicks],
        backgroundColor: ['#1DB954', '#E4405F'],
        borderRadius: 8,
        barThickness: 80
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      aspectRatio: 2,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Action Type Breakdown',
          color: '#fff',
          font: { size: 16, weight: 'bold' },
          padding: { bottom: 20 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#888', stepSize: 1 },
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        },
        x: {
          ticks: { color: '#fff', font: { size: 13, weight: 'bold' } },
          grid: { display: false }
        }
      }
    }
  })
}

const renderPlatformActionChart = (platformActions) => {
  const ctx = document.getElementById('platformActionChart')
  if (!ctx) return

  ctx.style.marginBottom = '30px'
  ctx.style.display = 'block'
  if (analyticsCharts.platformAction) analyticsCharts.platformAction.destroy()

  analyticsCharts.platformAction = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['YouTube', 'Instagram', 'Spotify', 'Apple Music'],
      datasets: [
        {
          label: 'Audio Plays',
          data: [
            platformActions.youtube.play,
            platformActions.instagram.play,
            platformActions.spotify.play,
            platformActions.apple_music.play
          ],
          backgroundColor: '#1DB954',
          borderRadius: 8
        },
        {
          label: 'Link Clicks',
          data: [
            platformActions.youtube.click,
            platformActions.instagram.click,
            platformActions.spotify.click,
            platformActions.apple_music.click
          ],
          backgroundColor: '#E4405F',
          borderRadius: 8
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      aspectRatio: 2,
      plugins: {
        legend: {
          position: 'top',
          labels: { color: '#fff', padding: 15, font: { size: 12 } }
        },
        title: {
          display: true,
          text: 'Platform Actions Comparison',
          color: '#fff',
          font: { size: 16, weight: 'bold' },
          padding: { bottom: 20 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          stacked: true,
          ticks: { color: '#888', stepSize: 1 },
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        },
        x: {
          stacked: true,
          ticks: { color: '#888' },
          grid: { display: false }
        }
      }
    }
  })
}

const renderTopReleasesChart = (releaseStats) => {
  const ctx = document.getElementById('topReleasesChart')
  if (!ctx) return

  ctx.style.marginBottom = '30px'
  ctx.style.display = 'block'

  if (analyticsCharts.topReleases) analyticsCharts.topReleases.destroy()

  const platformColors = {
    youtube: '#FF0000',
    instagram: '#E4405F',
    spotify: '#1DB954',
    apple_music: 'white'
  }

  analyticsCharts.topReleases = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: releaseStats.map(r => r.name.length > 20 ? r.name.substring(0, 20) + '...' : r.name),
      datasets: [{
        label: 'Total Listeners',
        data: releaseStats.map(r => r.listeners),
        backgroundColor: releaseStats.map(r => platformColors[r.platform]),
        borderRadius: 8
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      aspectRatio: 1.5,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Top 5 Releases',
          color: '#fff',
          font: { size: 16, weight: 'bold' },
          padding: { bottom: 20 }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { color: '#888', stepSize: 1 },
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        },
        y: {
          ticks: { color: '#fff', font: { size: 11 } },
          grid: { display: false }
        }
      }
    }
  })
}

const renderEngagementStats = (listeners, previews) => {
  const container = document.getElementById('engagementStats')
  if (!container) return

  const totalListeners = listeners.length
  const uniqueVisitors = new Set(listeners.map(l => l.visitor_id)).size
  const avgListenersPerRelease = previews.length > 0 ? (totalListeners / previews.length).toFixed(1) : 0
  const totalPlays = listeners.filter(l => l.action_type === 'play').length
  const totalClicks = listeners.filter(l => l.action_type === 'click').length
  const playRate = totalListeners > 0 ? ((totalPlays / totalListeners) * 100).toFixed(1) : 0
  const clickRate = totalListeners > 0 ? ((totalClicks / totalListeners) * 100).toFixed(1) : 0

  container.style.display = 'grid'
  container.style.gridTemplateColumns = 'repeat(auto-fit, minmax(180px, 1fr))'
  container.style.gap = '15px'
  container.style.marginTop = '20px'

  container.innerHTML = `
    <div class="stat-card" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
  <div style="width: 48px; height: 48px; border-radius: 12px; background: var(--brand); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0;">
    <i class="ri-user-line"></i>
  </div>
  <div>
    <div style="font-size: 24px; font-weight: 700; color: white;">${totalListeners}</div>
    <div style="font-size: 11px; color: #999; margin-top: 2px;">Total Listeners</div>
  </div>
</div>

<div class="stat-card" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
  <div style="width: 48px; height: 48px; border-radius: 12px; background: var(--brand); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0;">
    <i class="ri-team-line"></i>
  </div>
  <div>
    <div style="font-size: 24px; font-weight: 700; color: white;">${uniqueVisitors}</div>
    <div style="font-size: 11px; color: #999; margin-top: 2px;">Unique Visitors</div>
  </div>
</div>

<div class="stat-card" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
  <div style="width: 48px; height: 48px; border-radius: 12px; background: var(--brand); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0;">
    <i class="ri-bar-chart-box-line"></i>
  </div>
  <div>
    <div style="font-size: 24px; font-weight: 700; color: white;">${avgListenersPerRelease}</div>
    <div style="font-size: 11px; color: #999; margin-top: 2px;">Avg Per Release</div>
  </div>
</div>

<div class="stat-card" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
  <div style="width: 48px; height: 48px; border-radius: 12px; background: var(--brand); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0;">
    <i class="ri-play-circle-line"></i>
  </div>
  <div>
    <div style="font-size: 24px; font-weight: 700; color: white;">${totalPlays}</div>
    <div style="font-size: 11px; color: #999; margin-top: 2px;">Total Plays</div>
    <div style="font-size: 10px; color: #667eea; margin-top: 2px;">${playRate}% play rate</div>
  </div>
</div>

<div class="stat-card" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
  <div style="width: 48px; height: 48px; border-radius: 12px; background: var(--brand); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0;">
    <i class="ri-links-line"></i>
  </div>
  <div>
    <div style="font-size: 24px; font-weight: 700; color: white;">${totalClicks}</div>
    <div style="font-size: 11px; color: #999; margin-top: 2px;">Link Clicks</div>
    <div style="font-size: 10px; color: #667eea; margin-top: 2px;">${clickRate}% click rate</div>
  </div>
</div>

<div class="stat-card" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;">
  <div style="width: 48px; height: 48px; border-radius: 12px; background: var(--brand); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0;">
    <i class="ri-music-2-line"></i>
  </div>
  <div>
    <div style="font-size: 24px; font-weight: 700; color: white;">${previews.length}</div>
    <div style="font-size: 11px; color: #999; margin-top: 2px;">Active Releases</div>
  </div>
</div>
  `
}

const platformConfig = {
  youtube: { icon: 'ri-youtube-fill', name: 'YouTube', color: '#FF0000' },
  instagram: { icon: 'ri-instagram-fill', name: 'Instagram', color: '#E4405F' },
  spotify: { icon: 'ri-spotify-fill', name: 'Spotify', color: '#1DB954' },
  apple_music: { icon: 'ri-apple-fill', name: 'Apple Music', color: '#ffffff' }
}

const buildPreviewCard = (preview) => {
  const cfg = platformConfig[preview.platform]
  const thumb = preview.thumbnail_url || window.currentUser?.profile_picture || 'user.webp'
  const name = window.currentUser?.stage_name || 'Artist'

  const canEdit = isPro || window.currentUserLimits?.edits_remaining > 0

  return `
    <div class="span-12 preview-card" data-preview-id="${preview.id}" data-animate>
      <div class="my-post-card" data-animate>
        <div class="post-header post-header-dark">
          <div class="post-header-left">
            <img src="${thumb}" class="preview-thumbnail">
            <div class="post-header-info">
              <strong>${name}</strong>
              <div class="muted"><a href="${preview.release_url}" target="_blank">View release</a></div>
            </div>
          </div>
          <div class="post-header-right">
            ${canEdit ? `
              <button class="btn ghost edit-preview-btn" data-preview-id="${preview.id}" title="Edit release">
                <i class="ri-edit-line ri-xl edit-icon"></i>
              </button>
            ` : ''}
            <button class="btn ghost delete-preview-btn" data-preview-id="${preview.id}" title="Delete release">
              <i class="ri-delete-bin-line ri-xl delete-icon"></i>
            </button>
            <a href="${preview.release_url}" target="_blank">
              <button class="btn-icon platform-icon-btn" title="Open ${cfg.name}">
                <i class="${cfg.icon} ri-xl"></i>
              </button>
            </a>
          </div>
        </div>
        ${preview.preview_audio_url ? `
          <div class="d-post-body audio-preview-body">
            <div class="custom-audio-player" data-audio-src="${preview.preview_audio_url}" data-preview-id="${preview.id}">
              <audio style="display:none;"><source src="${preview.preview_audio_url}"></audio>
              <div class="audio-controls">
                <button class="play-pause-btn">
                  <i class="ri-play-fill play-icon"></i>
                </button>
                <div class="audio-info">
                  <div class="audio-title">${preview.release_name}</div>
                  <div class="audio-artist">${name}</div>
                </div>
                <div class="time-display">0:00 / ${formatTime(preview.duration_seconds||0)}</div>
              </div>
              <div class="waveform-container">
                <canvas class="waveform-canvas"></canvas>
                <div class="progress-overlay"></div>
              </div>
            </div>
          </div>
        ` : `<div class="d-post-body release-name-only"><a class="t-400">${preview.release_name}</a></div>`}
        <div class="row preview-stats">
          <div class="col-4"><div class="muted t-s">Listeners</div><div class="nowrap t-800 listener-count">0</div></div>
          <div class="col-34"><div class="muted t-s">Duration</div><div class="t-800">${formatTime(preview.duration_seconds||0)}</div></div>
          <div class="col-4"><div><span class="t-600 t-sm platform-tag">${cfg.name.toUpperCase()}</span></div><div class="muted t-s">Platform</div></div>
        </div>
      </div>
    </div>
  `
}

const initAudioPlayer = (container, previewId) => {
  const player = container.querySelector('.custom-audio-player')
  if (!player) return

  const audio = player.querySelector('audio')
  const btn = player.querySelector('.play-pause-btn')
  const icon = btn.querySelector('i')
  const time = player.querySelector('.time-display')
  const wave = player.querySelector('.waveform-container')
  const canvas = player.querySelector('.waveform-canvas')
  const progress = player.querySelector('.progress-overlay')
  const ctx = canvas.getContext('2d')

  canvas.width = wave.offsetWidth
  canvas.height = 60

  const drawWaveform = () => {
    ctx.clearRect(0, 0, canvas.width, 60)
    for (let i = 0; i < 100; i++) {
      const h = Math.random() * 48 + 6
      const x = i * (canvas.width / 100)
      const y = (60 - h) / 2
      ctx.fillStyle = 'rgba(255,255,255,0.3)'
      ctx.fillRect(x, y, (canvas.width / 100) - 2, h)
    }
  }

  drawWaveform()

  let tracked = false
  btn.onclick = async () => {
    if (audio.paused) {
      document.querySelectorAll('audio').forEach(a => {
        if (a !== audio) {
          a.pause()
          const otherIcon = a.closest('.custom-audio-player')?.querySelector('.play-pause-btn i')
          if (otherIcon) otherIcon.className = 'ri-play-fill play-icon'
          a.closest('.custom-audio-player')?.querySelector('.play-pause-btn')?.classList.remove('playing')
        }
      })
      audio.play()
      icon.className = 'ri-pause-fill play-icon'
      btn.classList.add('playing')
      if (!tracked && window.currentSession?.user?.id) {
        await trackListener(previewId, 'play', window.currentSession.user.id)
        tracked = true
      }
    } else {
      audio.pause()
      icon.className = 'ri-play-fill play-icon'
      btn.classList.remove('playing')
    }
  }

  audio.ontimeupdate = () => {
    time.textContent = `${formatTime(Math.floor(audio.currentTime))} / ${formatTime(Math.floor(audio.duration)||0)}`
    progress.style.width = ((audio.currentTime / audio.duration) * 100) + '%'
  }

  wave.onclick = (e) => {
    const rect = wave.getBoundingClientRect()
    audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration
  }

  audio.onended = () => {
    icon.className = 'ri-play-fill play-icon'
    btn.classList.remove('playing')
    progress.style.width = '0%'
  }

  window.addEventListener('resize', () => {
    canvas.width = wave.offsetWidth
    drawWaveform()
  })
}

const loadPreviews = async (userId) => {
  const container = document.getElementById('releasesContainer')
  if (!container) return

  const limits = await checkUserLimits(userId)
  window.currentUserLimits = limits

  const { data: previews } = await supabase.from('music_previews').select('*').eq('user_id', userId).eq('is_active', true).order('created_at', { ascending: false })

  if (!previews?.length) {
    container.innerHTML = `
      <div class="span-12 no-releases-container">
        <div class="no-releases-content">
          <img src="pro.svg" alt="No Releases" class="no-releases-image" />
          <h3 class="no-releases-title">No Releases Yet</h3>
          <p class="no-releases-text">Start sharing your music by adding your first release above.</p>
          <div class="platform-grid">
            <div class="platform-item"><i class="ri-spotify-fill platform-spotify"></i><div>Spotify</div></div>
            <div class="platform-item"><i class="ri-youtube-fill platform-youtube"></i><div>YouTube</div></div>
            <div class="platform-item"><i class="ri-instagram-fill platform-instagram"></i><div>Instagram</div></div>
            <div class="platform-item"><i class="ri-apple-fill platform-apple"></i><div>Apple Music</div></div>
          </div>
        </div>
      </div>
    `
    return
  }

  const links = await getSocialLinks(userId)
  const grouped = previews.reduce((acc, p) => ({ ...acc, [p.platform]: [...(acc[p.platform]||[]), p] }), {})

  container.innerHTML = ''

  Object.entries(grouped).forEach(([platform, items]) => {
    const cfg = platformConfig[platform]
    const username = links[platform]?.username || window.currentUser?.stage_name || 'Artist'

    const section = document.createElement('div')
    section.className = 'posts span-4'
    section.innerHTML = `
      <div class="platform-section-header">
        <div class="post-header platform-post-header">
          <div class="post-header-left">
            <span><i class="${cfg.icon} ri-xl" style="color:${cfg.color};"></i></span>
            <div class="post-header-info">
              <strong><a>${cfg.name}</a><a class="t-sm t-400">@${username}</a></strong>
              <div class="muted"><a class="profile">Available here!</a></div>
            </div>
          </div>
          <div class="post-header-right">
            <a href="${links[platform]?.url||'#'}" target="_blank">
              <button class="btn primary external-link-btn" title="Visit ${cfg.name}">
                <i class="ri-external-link-line ri-xl"></i>
              </button>
            </a>
            <button class="btn primary platform-share-btn" data-platform="${platform}" data-username="${username}" title="Copy ${cfg.name} link">
              <i class="ri-share-line ri-xl"></i>
            </button>
            <button class="btn primary platform-delete-all-btn" data-platform="${platform}" data-count="${items.length}" title="Delete all ${cfg.name} releases">
              <i class="ri-delete-bin-line ri-xl"></i>
            </button>
          </div>
        </div>
      </div>
      <section class="grid-12 platform-releases-grid"></section>
    `

    const grid = section.querySelector('.platform-releases-grid')
    items.forEach(p => {
      grid.insertAdjacentHTML('beforeend', buildPreviewCard(p))
      setTimeout(() => {
        const card = grid.querySelector(`[data-preview-id="${p.id}"]`)
        if (p.preview_audio_url) initAudioPlayer(card, p.id)
      }, 100)
    })

    container.appendChild(section)
  })

  previews.forEach(async p => {
    const count = await getListenerCount(p.id)
    const el = document.querySelector(`[data-preview-id="${p.id}"] .listener-count`)
    if (el) el.textContent = count
  })

  displayPlatformIcons(Object.keys(grouped))
}

const displayPlatformIcons = (platforms) => {
  const icons = document.querySelector('.artist__icons')
  if (!icons) return

  icons.innerHTML = ''
  
  const uniquePlatforms = [...new Set(platforms)]
  
  uniquePlatforms.forEach(platform => {
    const cfg = platformConfig[platform]
    if (!cfg) return
    
    const iconWrapper = document.createElement('div')
    iconWrapper.style.display = 'inline-block'
    
    const i = document.createElement('i')
    i.className = cfg.icon
    i.style.color = cfg.color
    i.title = cfg.name
    
    iconWrapper.appendChild(i)
    icons.appendChild(iconWrapper)
  })
}

const setupEditModal = (session) => {
  const modal = document.createElement('div')
  modal.id = 'editModal'
  modal.className = 'modal-overlay'
  modal.innerHTML = `
    <div class="modal-content-edit">
      <div class="modal-header">
        <h3 class="modal-title">Edit Release</h3>
        <button id="editModalClose" class="modal-close-btn"><i class="ri-close-line"></i></button>
      </div>
      <form id="editForm">
        <div class="form-group">
          <label class="form-label">Platform</label>
          <div class="custom-select-edit">
            <div class="select-selected-edit btn ghost t-sm" style="background: none;color: white">Select Platform</div>
            <div class="select-items-edit" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px;padding-top:10px;">
              <div data-platform="youtube" style="display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,0.04);transition:all .25s ease;" onmouseover="this.style.background='rgba(255,0,0,0.12)'" onmouseout="this.style.background='rgba(255,255,255,0.04)'">
                <i class="ri-youtube-fill" style="font-size:20px;color:#ff0000;"></i>
                <span>YouTube</span>
              </div>
              <div data-platform="instagram" style="display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,0.04);transition:all .25s ease;" onmouseover="this.style.background='rgba(225,48,108,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.04)'">
                <i class="ri-instagram-fill" style="font-size:20px;color:#e1306c;"></i>
                <span>Instagram</span>
              </div>
              <div data-platform="spotify" style="display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,0.04);transition:all .25s ease;" onmouseover="this.style.background='rgba(30,215,96,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.04)'">
                <i class="ri-spotify-fill" style="font-size:20px;color:white;"></i>
                <span>Spotify</span>
              </div>
              <div data-platform="apple_music" style="display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,0.04);transition:all .25s ease;" onmouseover="this.style.background='rgba(255,45,85,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.04)'">
                <i class="ri-apple-fill" style="font-size:20px;color:#ff2d55;"></i>
                <span>Apple Music</span>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Username</label>
          <input id="editUsername" type="text" class="form-input" placeholder="Your username">
        </div>
        <div class="form-group">
          <label class="form-label">Release Name</label>
          <input id="editReleaseName" type="text" class="form-input" placeholder="Release name">
        </div>
        <div class="form-group">
          <label class="form-label">Release URL</label>
          <input id="editReleaseUrl" type="text" class="form-input" placeholder="https://...">
        </div>
        <div class="form-group">
          <label class="form-label">Audio Preview (Optional)</label>
          <div id="editDropzone" class="dropzone"><i class="ri-upload-cloud-2-line"></i> Drop new audio or <u>browse</u></div>
          <input id="editAudioInput" type="file" accept="audio/*" style="display:none;">
        </div>
        <div class="modal-actions">
          <button type="button" id="editCancelBtn" class="btn-cancel">Cancel</button>
          <button type="submit" id="editSubmitBtn" class="btn-submit"><i class="ri-save-line"></i> Update</button>
        </div>
      </form>
    </div>
  `

  document.body.appendChild(modal)

  let editingPreviewId = null
  let editSelectedFile = null
  let editSelectedPlatform = 'youtube'

  const editPlatformSelect = modal.querySelector('.select-selected-edit')
  const editCustomSelect = modal.querySelector('.custom-select-edit')

  editPlatformSelect.onclick = (e) => {
    e.stopPropagation()
    editCustomSelect.classList.toggle('active')
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.custom-select-edit')) {
      editCustomSelect.classList.remove('active')
    }
  })

  modal.querySelectorAll('.select-items-edit div').forEach(opt => {
    opt.onclick = (e) => {
      e.stopPropagation()
      editSelectedPlatform = opt.dataset.platform
      editPlatformSelect.innerHTML = `${opt.textContent}`
      editCustomSelect.classList.remove('active')
    }
  })

  const editDropzone = modal.querySelector('#editDropzone')
  const editAudioInput = modal.querySelector('#editAudioInput')

  editDropzone.onclick = () => editAudioInput.click()
  editDropzone.ondragover = (e) => { e.preventDefault(); editDropzone.classList.add('dragover') }
  editDropzone.ondragleave = () => editDropzone.classList.remove('dragover')
  editDropzone.ondrop = (e) => {
    e.preventDefault()
    editDropzone.classList.remove('dragover')
    const file = e.dataTransfer.files[0]
    if (file?.type.startsWith('audio/')) {
      editSelectedFile = file
      editDropzone.innerHTML = `<i class="ri-music-2-line"></i> ${file.name}`
    }
  }

  editAudioInput.onchange = (e) => {
    editSelectedFile = e.target.files[0]
    if (editSelectedFile) editDropzone.innerHTML = `<i class="ri-music-2-line"></i> ${editSelectedFile.name}`
  }

  const closeModal = () => {
    modal.classList.remove('active')
    editingPreviewId = null
    editSelectedFile = null
    editCustomSelect.classList.remove('active')
  }

  modal.querySelector('#editModalClose').onclick = closeModal
  modal.querySelector('#editCancelBtn').onclick = closeModal
  modal.onclick = (e) => { if (e.target === modal) closeModal() }

  modal.querySelector('#editForm').onsubmit = async (e) => {
    e.preventDefault()

    const username = modal.querySelector('#editUsername').value.trim()
    const releaseName = modal.querySelector('#editReleaseName').value.trim()
    const releaseUrl = modal.querySelector('#editReleaseUrl').value.trim()
    const submitBtn = modal.querySelector('#editSubmitBtn')

    if (!username || !releaseName || !releaseUrl) return notify('Fill all fields', '#ef4444')

    const editCheck = await canUpload(session.user.id, 'edit')
    if (!editCheck.allowed) {
      if (editCheck.showUpgrade) showPremiumBottomSheet()
      return notify(editCheck.message, '#ef4444')
    }

    submitBtn.disabled = true
    submitBtn.innerHTML = '<i class="ri-loader-4-line"></i> Updating...'

    try {
      const url = releaseUrl.includes('://') ? releaseUrl : `https://${releaseUrl}`
      await saveSocialLink(editSelectedPlatform, username, url, session.user.id)

      let audioData = null
      if (editSelectedFile) {
        const { data: currentPreview } = await supabase
          .from('music_previews')
          .select('preview_audio_url')
          .eq('id', editingPreviewId)
          .single()

        if (!currentPreview.preview_audio_url) {
          const audioCheck = await canUpload(session.user.id, 'audio')
          if (!audioCheck.allowed) {
            if (audioCheck.showUpgrade) showPremiumBottomSheet()
            throw new Error(audioCheck.message)
          }
        }

        submitBtn.innerHTML = '<i class="ri-upload-cloud-2-line"></i> Uploading audio...'

        const { data: oldPreview } = await supabase.from('music_previews').select('preview_audio_url').eq('id', editingPreviewId).single()

        if (oldPreview?.preview_audio_url) {
          try {
            const path = new URL(oldPreview.preview_audio_url).pathname.split('/audio-previews/')[1]
            if (path) await supabase.storage.from('audio-previews').remove([path])
          } catch {}
        }

        audioData = await uploadAudio(editSelectedFile, session)
      }

      const updateData = { release_name: releaseName, platform: editSelectedPlatform, release_url: url }
      if (audioData) {
        updateData.preview_audio_url = audioData.url
        updateData.duration_seconds = audioData.duration
      }

      const { error: updateError } = await supabase
        .from('music_previews')
        .update(updateData)
        .eq('id', editingPreviewId)
        .eq('user_id', session.user.id)

      if (updateError) throw updateError

      notify('Release updated!', '#10b981')
      closeModal()

      await loadPreviews(session.user.id)
      await setupAdvancedAnalytics(session.user.id)
      await updateLimitsDisplay(session.user.id)

    } catch (error) {
      notify(error.message || 'Update failed', '#ef4444')
    } finally {
      submitBtn.disabled = false
      submitBtn.innerHTML = '<i class="ri-save-line"></i> Update'
    }
  }

  document.addEventListener('click', async (e) => {
    const editBtn = e.target.closest('.edit-preview-btn')
    if (!editBtn) return

    const previewId = editBtn.dataset.previewId

    modal.classList.add('active')
    modal.querySelector('#editUsername').value = ''
    modal.querySelector('#editReleaseName').value = 'Loading...'
    modal.querySelector('#editReleaseUrl').value = ''
    editPlatformSelect.innerHTML = 'Loading...'
    editDropzone.innerHTML = '<i class="ri-loader-4-line"></i> Loading...'
    
    const submitBtn = modal.querySelector('#editSubmitBtn')
    submitBtn.disabled = true

    try {
      const { data: preview } = await supabase.from('music_previews').select('*').eq('id', previewId).eq('user_id', session.user.id).single()

      editingPreviewId = previewId

      const links = await getSocialLinks(session.user.id)
      const platformLink = links[preview.platform]

      modal.querySelector('#editUsername').value = platformLink?.username || ''
      modal.querySelector('#editReleaseName').value = preview.release_name
      modal.querySelector('#editReleaseUrl').value = preview.release_url

      const platformNames = { youtube: 'YouTube', instagram: 'Instagram', spotify: 'Spotify', apple_music: 'Apple Music' }
      editPlatformSelect.innerHTML = `${platformNames[preview.platform] || 'Select Platform'}`
      editSelectedPlatform = preview.platform

      if (preview.preview_audio_url) {
        editDropzone.innerHTML = `<i class="ri-music-2-line"></i> Current: ${preview.duration_seconds}s - Upload new to replace`
      } else {
        editDropzone.innerHTML = '<i class="ri-upload-cloud-2-line"></i> Drop new audio or <u>browse</u>'
      }

      submitBtn.disabled = false

    } catch (error) {
      closeModal()
      notify('Failed to load release', '#ef4444')
    }
  })
}

const setupForm = (session) => {
  const form = document.getElementById('uploadForm')
  let selectedFile = null
  let selectedPlatform = null

  const platformNameToKey = {
    'Youtube': 'youtube',
    'YouTube': 'youtube',
    'Instagram': 'instagram',
    'Spotify': 'spotify',
    'Apple Music': 'apple_music'
  }

  const customSelect = document.querySelector('#uploadForm .custom-select')
  const selected = customSelect?.querySelector('.select-selected')
  
  if (customSelect && selected) {
    const observer = new MutationObserver(() => {
      const displayText = selected.textContent.trim()
      const platformKey = platformNameToKey[displayText]
      
      if (platformKey) {
        selectedPlatform = platformKey
      }
    })
    
    observer.observe(selected, { 
      childList: true, 
      characterData: true, 
      subtree: true 
    })
    
    setTimeout(() => {
      document.querySelectorAll('.select-items-portal div').forEach(item => {
        item.addEventListener('click', () => {
          const displayText = item.textContent.trim()
          const platformKey = platformNameToKey[displayText]
          
          if (platformKey) {
            selectedPlatform = platformKey
          }
        })
      })
    }, 100)
  }

  const dropzone = document.getElementById('dropAudio')
  const fileInput = document.getElementById('uFile')

  dropzone.onclick = () => fileInput.click()
  
  dropzone.ondragover = (e) => {
    e.preventDefault()
    dropzone.classList.add('dragover')
  }
  
  dropzone.ondragleave = () => {
    dropzone.classList.remove('dragover')
  }
  
  dropzone.ondrop = (e) => {
    e.preventDefault()
    dropzone.classList.remove('dragover')
    const file = e.dataTransfer.files[0]
    if (file && file.type.startsWith('audio/')) {
      selectedFile = file
      dropzone.innerHTML = `<i class="ri-music-2-line"></i> ${file.name}`
    }
  }

  fileInput.onchange = (e) => {
    selectedFile = e.target.files[0]
    if (selectedFile) {
      dropzone.innerHTML = `<i class="ri-music-2-line"></i> ${selectedFile.name}`
    }
  }

  document.getElementById('uReset').onclick = () => {
    form.reset()
    selectedFile = null
    selectedPlatform = null
    dropzone.innerHTML = '<i class="ri-upload-cloud-2-line"></i> Drop audio file preview here or <u>browse</u>'
    if (selected) selected.textContent = 'Select Platform'
  }

  form.onsubmit = async (e) => {
    e.preventDefault()

    const username = document.getElementById('uDesc').value.trim()
    const releaseName = document.getElementById('uTags').value.trim()
    const releaseUrl = document.getElementById('uBpm').value.trim()
    const submitBtn = document.getElementById('uSubmit')

    if (!selectedPlatform || !username || !releaseName || !releaseUrl) {
      return notify('Please fill all fields', '#ef4444')
    }

    const releaseCheck = await canUpload(session.user.id, 'release')
    if (!releaseCheck.allowed) {
      if (releaseCheck.showUpgrade) showPremiumBottomSheet()
      return notify(releaseCheck.message, '#ef4444')
    }

    submitBtn.disabled = true
    submitBtn.innerHTML = '<i class="ri-loader-4-line"></i> Uploading...'

    try {
      const url = releaseUrl.includes('://') ? releaseUrl : `https://${releaseUrl}`
      await saveSocialLink(selectedPlatform, username, url, session.user.id)

      let audioData = null
      if (selectedFile) {
        submitBtn.innerHTML = '<i class="ri-upload-cloud-2-line"></i> Processing audio...'
        audioData = await uploadAudio(selectedFile, session)
      }

      const { error: insertError } = await supabase.from('music_previews').insert({
        user_id: session.user.id,
        platform: selectedPlatform,
        release_name: releaseName,
        release_url: url,
        preview_audio_url: audioData?.url || null,
        duration_seconds: audioData?.duration || null,
        thumbnail_url: window.currentUser?.profile_picture || null,
        is_active: true,
        created_at: new Date().toISOString()
      })

      if (insertError) throw insertError

      const { error: countError } = await supabase.rpc('increment_release_count', {
        user_id: session.user.id
      })

      if (countError) console.warn('Count update failed:', countError)

      if (audioData) {
        const { error: audioCountError } = await supabase.rpc('increment_audio_count', {
          user_id: session.user.id
        })
        if (audioCountError) console.warn('Audio count update failed:', audioCountError)
      }

      notify('Release uploaded successfully!', '#10b981')
      
      form.reset()
      selectedFile = null
      selectedPlatform = null
      dropzone.innerHTML = '<i class="ri-upload-cloud-2-line"></i> Drop audio file preview here or <u>browse</u>'
      if (selected) selected.textContent = 'Select Platform'

      await loadPreviews(session.user.id)
      await setupAdvancedAnalytics(session.user.id)
      await updateLimitsDisplay(session.user.id)

    } catch (error) {
      notify(error.message || 'Upload failed', '#ef4444')
    } finally {
      submitBtn.disabled = false
      submitBtn.innerHTML = '<i class="ri-upload-2-line"></i> Upload'
    }
  }
}

const setupDeleteHandlers = (session) => {
  document.addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.delete-preview-btn')
    if (!deleteBtn) return

    const previewId = deleteBtn.dataset.previewId
    const confirmed = await confirm('Are you sure you want to delete this release? This action cannot be undone.')
    
    if (!confirmed) return

    try {
      const { data: preview } = await supabase
        .from('music_previews')
        .select('preview_audio_url')
        .eq('id', previewId)
        .eq('user_id', session.user.id)
        .single()

      if (preview?.preview_audio_url) {
        try {
          const path = new URL(preview.preview_audio_url).pathname.split('/audio-previews/')[1]
          if (path) await supabase.storage.from('audio-previews').remove([path])
        } catch (err) {
          console.warn('Audio file deletion warning:', err)
        }
      }

      const { error } = await supabase
        .from('music_previews')
        .update({ is_active: false })
        .eq('id', previewId)
        .eq('user_id', session.user.id)

      if (error) throw error

      notify('Release deleted', '#10b981')
      await loadPreviews(session.user.id)
      await setupAdvancedAnalytics(session.user.id)
      await updateLimitsDisplay(session.user.id)

    } catch (error) {
      notify('Delete failed', '#ef4444')
    }
  })

  document.addEventListener('click', async (e) => {
    const deleteAllBtn = e.target.closest('.platform-delete-all-btn')
    if (!deleteAllBtn) return

    const platform = deleteAllBtn.dataset.platform
    const count = deleteAllBtn.dataset.count
    const confirmed = await confirm(`Delete all ${count} releases from this platform?`)
    
    if (!confirmed) return

    try {
      const { data: previews } = await supabase
        .from('music_previews')
        .select('id, preview_audio_url')
        .eq('user_id', session.user.id)
        .eq('platform', platform)
        .eq('is_active', true)

      for (const preview of previews || []) {
        if (preview.preview_audio_url) {
          try {
            const path = new URL(preview.preview_audio_url).pathname.split('/audio-previews/')[1]
            if (path) await supabase.storage.from('audio-previews').remove([path])
          } catch {}
        }
      }

      const { error } = await supabase
        .from('music_previews')
        .update({ is_active: false })
        .eq('user_id', session.user.id)
        .eq('platform', platform)

      if (error) throw error

      notify('All releases deleted', '#10b981')
      await loadPreviews(session.user.id)
      await setupAdvancedAnalytics(session.user.id)
      await updateLimitsDisplay(session.user.id)

    } catch (error) {
      notify('Delete failed', '#ef4444')
    }
  })

  document.addEventListener('click', (e) => {
    const shareBtn = e.target.closest('.platform-share-btn')
    if (!shareBtn) return

    const platform = shareBtn.dataset.platform
    const username = shareBtn.dataset.username
    const cfg = platformConfig[platform]

    const urlMap = {
      youtube: `https://youtube.com/@${username}`,
      instagram: `https://instagram.com/${username}`,
      spotify: `https://open.spotify.com/user/${username}`,
      apple_music: `https://music.apple.com/profile/${username}`
    }

    const url = urlMap[platform] || '#'
    
    navigator.clipboard.writeText(url).then(() => {
      notify(`${cfg.name} link copied!`, '#10b981')
    }).catch(() => {
      notify('Failed to copy link', '#ef4444')
    })
  })
}

const updateLimitsDisplay = async (userId) => {
  const limits = await checkUserLimits(userId)
  
  const releaseDisplay = document.querySelector('.release-limit-display')
  const audioDisplay = document.querySelector('.audio-limit-display')
  const editsDisplay = document.querySelector('.edits-limit-display')
  
  const releaseProgress = document.querySelector('.release-progress')
  const audioProgress = document.querySelector('.audio-progress')
  const editsProgress = document.querySelector('.edits-progress')

  if (isPro) {
    if (releaseDisplay) releaseDisplay.textContent = 'Unlimited'
    if (audioDisplay) audioDisplay.textContent = 'Unlimited'
    if (editsDisplay) editsDisplay.textContent = 'Unlimited'
    
    if (releaseProgress) releaseProgress.style.width = '100%'
    if (audioProgress) audioProgress.style.width = '100%'
    if (editsProgress) editsProgress.style.width = '100%'
    
    document.querySelectorAll('.limit-item').forEach(item => item.classList.add('unlimited'))
  } else {
    if (releaseDisplay) releaseDisplay.textContent = `${limits.current_release_count}/${limits.max_releases}`
    if (audioDisplay) audioDisplay.textContent = `${limits.current_audio_count}/${limits.max_audio_previews}`
    if (editsDisplay) editsDisplay.textContent = `${limits.edits_remaining} remaining`
    
    if (releaseProgress) releaseProgress.style.width = `${(limits.current_release_count / limits.max_releases) * 100}%`
    if (audioProgress) audioProgress.style.width = `${(limits.current_audio_count / limits.max_audio_previews) * 100}%`
    if (editsProgress) editsProgress.style.width = `${((limits.max_edits - limits.edits_remaining) / limits.max_edits) * 100}%`
  }
}

const setupModals = () => {
  const limitModal = document.getElementById('limitModal')
  const limitClose = document.getElementById('limitClose')
  const limitModalBtn = document.querySelector('.limitModalBtn')

  if (limitModalBtn) {
    limitModalBtn.onclick = () => limitModal?.classList.remove('hidden')
  }

  if (limitClose) {
    limitClose.onclick = () => limitModal?.classList.add('hidden')
  }

  if (limitModal) {
    limitModal.onclick = (e) => {
      if (e.target === limitModal) limitModal.classList.add('hidden')
    }
  }
}

const setupLogout = () => {
  document.querySelector('.logout-btn')?.addEventListener('click', async () => {
    await supabase.auth.signOut()
    window.location.href = 'register'
  })
}

const init = async () => {
  try {
    const { session } = await initAuth()
    if (!session) return

    await Promise.all([
      loadPreviews(session.user.id),
      setupAdvancedAnalytics(session.user.id),
      updateLimitsDisplay(session.user.id)
    ])

    setupForm(session)
    setupEditModal(session)
    setupDeleteHandlers(session)
    setupModals()
    setupLogout()

    document.querySelectorAll('[data-animate]').forEach((el, i) => {
      setTimeout(() => el.classList.add('animated'), i * 50)
    })

  } catch (error) {
    console.error('Init error:', error)
    notify('Failed to load dashboard', '#ef4444')
  }
}

init()
</script>

<script>
document.addEventListener("click", e => {
  if (e.target.closest(".link-1")) {
    document.getElementById("linkModal").classList.remove("hidden");
  }
  if (e.target.closest("#linkClose") || e.target.id === "linkModal") {
    document.getElementById("linkModal").classList.add("hidden");
  }
  if (e.target.closest(".limitModalBtn")) {
    document.getElementById("limitModal").classList.remove("hidden");
  }
  if (e.target.closest("#limitClose") || e.target.id === "limitModal") {
    document.getElementById("limitModal").classList.add("hidden");
  }
});

document.querySelectorAll('.custom-select').forEach(select => {
  const selected = select.querySelector('.select-selected');
  const options = select.dataset.options.split(',');

  const dropdown = document.createElement('div');
  dropdown.classList.add('select-items-portal');
  options.forEach(opt => {
    const div = document.createElement('div');
    div.textContent = opt;
    dropdown.appendChild(div);

    div.addEventListener('click', e => {
      e.stopPropagation();
      selected.textContent = opt;
      dropdown.classList.remove('show');
      selected.classList.remove('active');
    });
  });
  document.body.appendChild(dropdown);

  selected.addEventListener('click', e => {
    e.stopPropagation();

    const rect = selected.getBoundingClientRect();
    dropdown.style.top = `${rect.bottom + window.scrollY}px`;
    dropdown.style.left = `${rect.left + window.scrollX}px`;
    dropdown.style.width = `${rect.width}px`;

    document.querySelectorAll('.select-items-portal.show').forEach(other => {
      if (other !== dropdown) {
        other.classList.remove('show');
        other.previousSelected?.classList.remove('active');
      }
    });

    dropdown.classList.toggle('show');
    selected.classList.toggle('active');
    dropdown.previousSelected = selected;
  });
});

document.addEventListener('click', () => {
  document.querySelectorAll('.select-items-portal.show').forEach(dropdown => {
    dropdown.classList.remove('show');
    dropdown.previousSelected?.classList.remove('active');
  });
});

['scroll','resize'].forEach(ev => {
  window.addEventListener(ev, () => {
    document.querySelectorAll('.select-items-portal.show').forEach(dropdown => {
      const selected = dropdown.previousSelected;
      if (!selected) return;
      const rect = selected.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.width = `${rect.width}px`;
    });
  });
});
</script>
</body>
</html>

